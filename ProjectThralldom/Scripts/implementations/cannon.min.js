(function(){var n=n||{},et,c,l,a,v,y,p,w,i,dt,t,b,k,f,h,g,nt,er,or,it,rt,ut,ft,o;this.Int32Array||(this.Int32Array=Array,this.Float32Array=Array);n.Mat3=function(n){this.elements=n?n:[0,0,0,0,0,0,0,0,0]};n.Mat3.prototype.identity=function(){this.elements[0]=1;this.elements[1]=0;this.elements[2]=0;this.elements[3]=0;this.elements[4]=1;this.elements[5]=0;this.elements[6]=0;this.elements[7]=0;this.elements[8]=1};n.Mat3.prototype.setZero=function(){var n=this.elements;n[0]=0;n[1]=0;n[2]=0;n[3]=0;n[4]=0;n[5]=0;n[6]=0;n[7]=0;n[8]=0};n.Mat3.prototype.setTrace=function(n){var t=this.elements;t[0]=n.x;t[4]=n.y;t[8]=n.z};n.Mat3.prototype.vmult=function(t,i){i=i||new n.Vec3;var r=this.elements,u=t.x,f=t.y,e=t.z;return i.x=r[0]*u+r[1]*f+r[2]*e,i.y=r[3]*u+r[4]*f+r[5]*e,i.z=r[6]*u+r[7]*f+r[8]*e,i};n.Mat3.prototype.smult=function(n){for(var t=0;t<this.elements.length;t++)this.elements[t]*=n};n.Mat3.prototype.mmult=function(t){for(var i,f,r,e=new n.Mat3,u=0;u<3;u++)for(i=0;i<3;i++){for(f=0,r=0;r<3;r++)f+=t.elements[u+r*3]*this.elements[r+i*3];e.elements[u+i*3]=f}return e};n.Mat3.prototype.solve=function(t,i){var u,e,a;i=i||new n.Vec3;var f=4,r=[];for(u=0;u<3*f;u++)r.push(0);for(u=0;u<3;u++)for(e=0;e<3;e++)r[u+f*e]=this.elements[u+3*e];r[3]=t.x;r[7]=t.y;r[11]=t.z;var c=3,l=c,s,h=4,o;do{if(u=l-c,r[u+f*u]===0)for(e=u+1;e<l;e++)if(r[u+f*e]!==0){s=h;do o=h-s,r[o+f*u]+=r[o+f*e];while(--s);break}if(r[u+f*u]!==0)for(e=u+1;e<l;e++){a=r[u+f*e]/r[u+f*u];s=h;do o=h-s,r[o+f*e]=o<=u?0:r[o+f*e]-r[o+f*u]*a;while(--s)}}while(--c);if(i.z=r[2*f+3]/r[2*f+2],i.y=(r[1*f+3]-r[1*f+2]*i.z)/r[1*f+1],i.x=(r[0*f+3]-r[0*f+2]*i.z-r[0*f+1]*i.y)/r[0*f+0],isNaN(i.x)||isNaN(i.y)||isNaN(i.z)||i.x===Infinity||i.y===Infinity||i.z===Infinity)throw"Could not solve equation! Got x=["+i.toString()+"], b=["+t.toString()+"], A=["+this.toString()+"]";return i};n.Mat3.prototype.e=function(n,t,i){if(i===undefined)return this.elements[t+3*n];this.elements[t+3*n]=i};n.Mat3.prototype.copy=function(t){t=t||new n.Mat3;for(var i=0;i<this.elements.length;i++)t.elements[i]=this.elements[i];return t};n.Mat3.prototype.toString=function(){for(var t="",n=0;n<9;n++)t+=this.elements[n]+",";return t};n.Mat3.prototype.reverse=function(t){var i,f,s;t=t||new n.Mat3;var a=3,u=6,r=[];for(i=0;i<a*u;i++)r.push(0);for(i=0;i<3;i++)for(f=0;f<3;f++)r[i+u*f]=this.elements[i+3*f];r[3]=1;r[9]=0;r[15]=0;r[4]=0;r[10]=1;r[16]=0;r[5]=0;r[11]=0;r[17]=1;var c=3,l=c,o,h=u,e;do{if(i=l-c,r[i+u*i]===0)for(f=i+1;f<l;f++)if(r[i+u*f]!==0){o=h;do e=h-o,r[e+u*i]+=r[e+u*f];while(--o);break}if(r[i+u*i]!==0)for(f=i+1;f<l;f++){s=r[i+u*f]/r[i+u*i];o=h;do e=h-o,r[e+u*f]=e<=i?0:r[e+u*f]-r[e+u*i]*s;while(--o)}}while(--c);i=2;do{f=i-1;do{s=r[i+u*f]/r[i+u*i];o=u;do e=u-o,r[e+u*f]=r[e+u*f]-r[e+u*i]*s;while(--o)}while(f--)}while(--i);i=2;do{s=1/r[i+u*i];o=u;do e=u-o,r[e+u*i]=r[e+u*i]*s;while(--o)}while(i--);i=2;do{f=2;do{if(e=r[a+f+u*i],isNaN(e)||e===Infinity)throw"Could not reverse! A=["+this.toString()+"]";t.e(i,f,e)}while(f--)}while(i--);return t};et=0;n.Vec3=function(n,t,i){this.x=n||0;this.y=t||0;this.z=i||0};n.Vec3.prototype.cross=function(t,i){var r=t.x,u=t.y,f=t.z,e=this.x,o=this.y,s=this.z;return i=i||new n.Vec3,i.x=o*f-s*u,i.y=s*r-e*f,i.z=e*u-o*r,i};n.Vec3.prototype.set=function(n,t,i){return this.x=n,this.y=t,this.z=i,this};n.Vec3.prototype.vadd=function(t,i){if(i)i.x=t.x+this.x,i.y=t.y+this.y,i.z=t.z+this.z;else return new n.Vec3(this.x+t.x,this.y+t.y,this.z+t.z)};n.Vec3.prototype.vsub=function(t,i){if(i)i.x=this.x-t.x,i.y=this.y-t.y,i.z=this.z-t.z;else return new n.Vec3(this.x-t.x,this.y-t.y,this.z-t.z)};n.Vec3.prototype.crossmat=function(){return new n.Mat3([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])};n.Vec3.prototype.normalize=function(){var i=this.x,r=this.y,u=this.z,t=Math.sqrt(i*i+r*r+u*u),n;return t>0?(n=1/t,this.x*=n,this.y*=n,this.z*=n):(this.x=0,this.y=0,this.z=0),t};n.Vec3.prototype.unit=function(t){t=t||new n.Vec3;var r=this.x,u=this.y,f=this.z,i=Math.sqrt(r*r+u*u+f*f);return i>0?(i=1/i,t.x=r*i,t.y=u*i,t.z=f*i):(t.x=1,t.y=0,t.z=0),t};n.Vec3.prototype.norm=function(){var n=this.x,t=this.y,i=this.z;return Math.sqrt(n*n+t*t+i*i)};n.Vec3.prototype.norm2=function(){return this.dot(this)};n.Vec3.prototype.distanceTo=function(n){var t=this.x,i=this.y,r=this.z,u=n.x,f=n.y,e=n.z;return Math.sqrt((u-t)*(u-t)+(f-i)*(f-i)+(e-r)*(e-r))};n.Vec3.prototype.mult=function(t,i){i=i||new n.Vec3;var r=this.x,u=this.y,f=this.z;return i.x=t*r,i.y=t*u,i.z=t*f,i};n.Vec3.prototype.dot=function(n){return this.x*n.x+this.y*n.y+this.z*n.z};n.Vec3.prototype.isZero=function(){return this.x===0&&this.y===0&&this.z===0};n.Vec3.prototype.negate=function(t){return t=t||new n.Vec3,t.x=-this.x,t.y=-this.y,t.z=-this.z,t};c=new n.Vec3;l=new n.Vec3;n.Vec3.prototype.tangents=function(n,t){var f=this.norm(),i,u,r;f>0?(i=c,u=1/f,i.set(this.x*u,this.y*u,this.z*u),r=l,Math.abs(i.x)<.9?(r.set(1,0,0),i.cross(r,n)):(r.set(0,1,0),i.cross(r,n)),i.cross(n,t)):(n.set(1,0,0).normalize(),t.set(0,1,0).normalize())};n.Vec3.prototype.toString=function(){return this.x+","+this.y+","+this.z};n.Vec3.prototype.copy=function(t){return t=t||new n.Vec3,t.x=this.x,t.y=this.y,t.z=this.z,t};n.Vec3.prototype.lerp=function(n,t,i){var r=this.x,u=this.y,f=this.z;i.x=r+(n.x-r)*t;i.y=u+(n.y-u)*t;i.z=f+(n.z-f)*t};n.Vec3.prototype.almostEquals=function(n,t){return(t===undefined&&(t=1e-6),Math.abs(this.x-n.x)>t||Math.abs(this.y-n.y)>t||Math.abs(this.z-n.z)>t)?!1:!0};n.Vec3.prototype.almostZero=function(n){return(n===undefined&&(n=1e-6),Math.abs(this.x)>n||Math.abs(this.y)>n||Math.abs(this.z)>n)?!1:!0};n.Quaternion=function(n,t,i,r){this.x=n!==undefined?n:0;this.y=t!==undefined?t:0;this.z=i!==undefined?i:0;this.w=r!==undefined?r:1};n.Quaternion.prototype.set=function(n,t,i,r){this.x=n;this.y=t;this.z=i;this.w=r};n.Quaternion.prototype.toString=function(){return this.x+","+this.y+","+this.z+","+this.w};n.Quaternion.prototype.setFromAxisAngle=function(n,t){var i=Math.sin(t*.5);this.x=n.x*i;this.y=n.y*i;this.z=n.z*i;this.w=Math.cos(t*.5)};n.Quaternion.prototype.toAxisAngle=function(t){t=t||new n.Vec3;this.normalize();var r=2*Math.acos(this.w),i=Math.sqrt(1-this.w*this.w);return i<.001?(t.x=this.x,t.y=this.y,t.z=this.z):(t.x=this.x/i,t.y=this.y/i,t.z=this.z/i),[t,r]};n.Quaternion.prototype.setFromVectors=function(n,t){var i=n.cross(t);this.x=i.x;this.y=i.y;this.z=i.z;this.w=Math.sqrt(Math.pow(n.norm(),2)*Math.pow(t.norm(),2))+n.dot(t);this.normalize()};var ot=new n.Vec3,st=new n.Vec3,ht=new n.Vec3;n.Quaternion.prototype.mult=function(t,i){i=i||new n.Quaternion;var f=this.w,r=ot,u=st,e=ht;return r.set(this.x,this.y,this.z),u.set(t.x,t.y,t.z),i.w=f*t.w-r.dot(u),r.cross(u,e),i.x=f*u.x+t.w*r.x+e.x,i.y=f*u.y+t.w*r.y+e.y,i.z=f*u.z+t.w*r.z+e.z,i};n.Quaternion.prototype.inverse=function(t){var r=this.x,u=this.y,f=this.z,e=this.w,i;return t=t||new n.Quaternion,this.conjugate(t),i=1/(r*r+u*u+f*f+e*e),t.x*=i,t.y*=i,t.z*=i,t.w*=i,t};n.Quaternion.prototype.conjugate=function(t){return t=t||new n.Quaternion,t.x=-this.x,t.y=-this.y,t.z=-this.z,t.w=this.w,t};n.Quaternion.prototype.normalize=function(){var n=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);n===0?(this.x=0,this.y=0,this.z=0,this.w=0):(n=1/n,this.x*=n,this.y*=n,this.z*=n,this.w*=n)};n.Quaternion.prototype.normalizeFast=function(){var n=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;n===0?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x*=n,this.y*=n,this.z*=n,this.w*=n)};n.Quaternion.prototype.vmult=function(t,i){if(i=i||new n.Vec3,this.w===0)i.x=t.x,i.y=t.y,i.z=t.z;else{var o=t.x,s=t.y,h=t.z,r=this.x,u=this.y,f=this.z,e=this.w,c=e*o+u*h-f*s,l=e*s+f*o-r*h,a=e*h+r*s-u*o,v=-r*o-u*s-f*h;i.x=c*e+v*-r+l*-f-a*-u;i.y=l*e+v*-u+a*-r-c*-f;i.z=a*e+v*-f+c*-u-l*-r}return i};n.Quaternion.prototype.copy=function(n){n.x=this.x;n.y=this.y;n.z=this.z;n.w=this.w};n.Quaternion.prototype.toEuler=function(n,t){var h;t=t||"YZX";var r,o,s,i=this.x,u=this.y,f=this.z,e=this.w;switch(t){case"YZX":if(h=i*u+f*e,h>.499&&(r=2*Math.atan2(i,e),o=Math.PI/2,s=0),h<-.499&&(r=-2*Math.atan2(i,e),o=-Math.PI/2,s=0),isNaN(r)){var l=i*i,a=u*u,c=f*f;r=Math.atan2(2*u*e-2*i*f,1-2*a-2*c);o=Math.asin(2*h);s=Math.atan2(2*i*e-2*u*f,1-2*l-2*c)}break;default:throw new Error("Euler order "+t+" not supported yet.");}n.y=r;n.z=o;n.x=s};n.EventTarget=function(){var n={};this.addEventListener=function(t,i){n[t]===undefined&&(n[t]=[]);n[t].indexOf(i)===-1&&n[t].push(i)};this.dispatchEvent=function(t){for(var i in n[t.type])n[t.type][i](t)};this.removeEventListener=function(t,i){var r=n[t].indexOf(i);r!==-1&&n[t].splice(r,1)}};n.ObjectPool=function(){this.objects=[];this.type=Object};n.ObjectPool.prototype.release=function(){for(var t=arguments.length,n=0;n!==t;n++)this.objects.push(arguments[n])};n.ObjectPool.prototype.get=function(){return this.objects.length===0?this.constructObject():this.objects.pop()};n.ObjectPool.prototype.constructObject=function(){throw new Error("constructObject() not implemented in this ObjectPool subclass yet!");};n.Vec3Pool=function(){n.ObjectPool.call(this);this.type=n.Vec3};n.Vec3Pool.prototype=new n.ObjectPool;n.Vec3Pool.prototype.constructObject=function(){return new n.Vec3};n.Shape=function(){this.type=0;this.aabbmin=new n.Vec3;this.aabbmax=new n.Vec3;this.boundingSphereRadius=0;this.boundingSphereRadiusNeedsUpdate=!0};n.Shape.prototype.constructor=n.Shape;n.Shape.prototype.computeBoundingSphereRadius=function(){throw"computeBoundingSphereRadius() not implemented for shape type "+this.type;};n.Shape.prototype.getBoundingSphereRadius=function(){return this.boundingSphereRadiusNeedsUpdate&&this.computeBoundingSphereRadius(),this.boundingSphereRadius};n.Shape.prototype.volume=function(){throw"volume() not implemented for shape type "+this.type;};n.Shape.prototype.calculateLocalInertia=function(){throw"calculateLocalInertia() not implemented for shape type "+this.type;};a=new n.Vec3;v=new n.Vec3;n.Shape.prototype.calculateTransformedInertia=function(t,i,r){r=r||new n.Vec3;var f=a,u=v;return this.calculateLocalInertia(t,f),i.vmult(f,u),r.x=Math.abs(u.x),r.y=Math.abs(u.y),r.z=Math.abs(u.z),r};n.Shape.calculateLocalAABB=function(){throw new Error(".calculateLocalAABB is not implemented for this Shape yet!");};n.Shape.types={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16};n.Body=function(t){n.EventTarget.apply(this);this.type=t;this.world=null;this.preStep=null;this.postStep=null;this.vlambda=new n.Vec3;this.collisionFilterGroup=1;this.collisionFilterMask=1};n.Body.DYNAMIC=1;n.Body.STATIC=2;n.Body.KINEMATIC=4;n.Particle=function(t,i){if(typeof t!="number")throw new Error("Argument 1 (mass) must be a number.");if(typeof i!="undefined"&&!(i instanceof n.Material))throw new Error("Argument 3 (material) must be an instance of CANNON.Material.");n.Body.call(this,"particle");this.position=new n.Vec3;this.initPosition=new n.Vec3;this.velocity=new n.Vec3;this.initVelocity=new n.Vec3;this.force=new n.Vec3;this.mass=t;this.invMass=t>0?1/t:0;this.material=i;this.linearDamping=.01;this.motionstate=t<=0?n.Body.STATIC:n.Body.DYNAMIC;this.allowSleep=!0;this.sleepState=0;this.sleepSpeedLimit=.1;this.sleepTimeLimit=1;this.timeLastSleepy=0};n.Particle.prototype=new n.Body;n.Particle.prototype.constructor=n.Particle;n.Particle.prototype.isAwake=function(){return this.sleepState===0};n.Particle.prototype.isSleepy=function(){return this.sleepState===1};n.Particle.prototype.isSleeping=function(){return this.sleepState===2};n.Particle.prototype.wakeUp=function(){var n=this.sleepState;this.sleepState=0;n===2&&this.dispatchEvent({type:"wakeup"})};n.Particle.prototype.sleep=function(){this.sleepState=2};n.Particle.prototype.sleepTick=function(n){if(this.allowSleep){var t=this.sleepState,i=this.velocity.norm2(),r=Math.pow(this.sleepSpeedLimit,2);t===0&&i<r?(this.sleepState=1,this.timeLastSleepy=n,this.dispatchEvent({type:"sleepy"})):t===1&&i>r?this.wakeUp():t===1&&n-this.timeLastSleepy>this.sleepTimeLimit&&(this.sleepState=2,this.dispatchEvent({type:"sleep"}))}};n.RigidBody=function(t,i,r){if(typeof t!="number")throw new Error("Argument 1 (mass) must be a number.");if(typeof r!="undefined"&&!(r instanceof n.Material))throw new Error("Argument 3 (material) must be an instance of CANNON.Material.");n.Particle.call(this,t,r);var u=this;this.tau=new n.Vec3;this.quaternion=new n.Quaternion;this.initQuaternion=new n.Quaternion;this.angularVelocity=new n.Vec3;this.initAngularVelocity=new n.Vec3;this.shape=i;this.inertia=new n.Vec3;i.calculateLocalInertia(t,this.inertia);this.inertiaWorld=new n.Vec3;this.inertia.copy(this.inertiaWorld);this.inertiaWorldAutoUpdate=!1;this.invInertia=new n.Vec3(this.inertia.x>0?1/this.inertia.x:0,this.inertia.y>0?1/this.inertia.y:0,this.inertia.z>0?1/this.inertia.z:0);this.invInertiaWorld=new n.Vec3;this.invInertia.copy(this.invInertiaWorld);this.invInertiaWorldAutoUpdate=!1;this.angularDamping=.01;this.aabbmin=new n.Vec3;this.aabbmax=new n.Vec3;this.aabbNeedsUpdate=!0;this.wlambda=new n.Vec3};n.RigidBody.prototype=new n.Particle(0);n.RigidBody.prototype.constructor=n.RigidBody;n.RigidBody.prototype.computeAABB=function(){this.shape.calculateWorldAABB(this.position,this.quaternion,this.aabbmin,this.aabbmax);this.aabbNeedsUpdate=!1};y=new n.Vec3;p=new n.Vec3;n.RigidBody.prototype.applyForce=function(n,t){var r=y,i;t.vsub(this.position,r);i=p;r.cross(n,i);this.force.vadd(n,this.force);this.tau.vadd(i,this.tau)};var ct=new n.Vec3,lt=new n.Vec3,at=new n.Vec3;n.RigidBody.prototype.applyImpulse=function(n,t){var u=ct,r,i;t.vsub(this.position,u);r=lt;n.copy(r);r.mult(this.invMass,r);this.velocity.vadd(r,this.velocity);i=at;u.cross(n,i);i.x*=this.invInertia.x;i.y*=this.invInertia.y;i.z*=this.invInertia.z;this.angularVelocity.vadd(i,this.angularVelocity)};n.Sphere=function(t){n.Shape.call(this);this.radius=t!==undefined?Number(t):1;this.type=n.Shape.types.SPHERE};n.Sphere.prototype=new n.Shape;n.Sphere.prototype.constructor=n.Sphere;n.Sphere.prototype.calculateLocalInertia=function(t,i){i=i||new n.Vec3;var r=2*t*this.radius*this.radius/5;return i.x=r,i.y=r,i.z=r,i};n.Sphere.prototype.volume=function(){return 4*Math.PI*this.radius/3};n.Sphere.prototype.computeBoundingSphereRadius=function(){this.boundingSphereRadiusNeedsUpdate=!1;this.boundingSphereRadius=this.radius};n.Sphere.prototype.calculateWorldAABB=function(n,t,i,r){for(var u,e=this.radius,o=["x","y","z"],f=0;f<o.length;f++)u=o[f],i[u]=n[u]-e,r[u]=n[u]+e};n.SPHSystem=function(){this.particles=[];this.density=1;this.smoothingRadius=1;this.speedOfSound=1;this.viscosity=.01;this.eps=1e-6;this.pressures=[];this.densities=[];this.neighbors=[]};n.SPHSystem.prototype.add=function(n){this.particles.push(n);this.neighbors.length<this.particles.length&&this.neighbors.push([])};n.SPHSystem.prototype.remove=function(n){var t=this.particles.indexOf(n);t!==-1&&(this.particles.splice(t,1),this.neighbors.length>this.particles.length&&this.neighbors.pop())};w=new n.Vec3;n.SPHSystem.prototype.getNeighbors=function(n,t){for(var i,f=this.particles.length,e=n.id,o=this.smoothingRadius*this.smoothingRadius,u=w,r=0;r!==f;r++)i=this.particles[r],i.position.vsub(n.position,u),e!==i.id&&u.norm2()<o&&t.push(i)};var vt=new n.Vec3,yt=new n.Vec3,pt=new n.Vec3,wt=new n.Vec3,bt=new n.Vec3,kt=new n.Vec3;n.SPHSystem.prototype.update=function(){for(var c,l,b,k,r,d,g,i,s,t,o,nt,v=this.particles.length,y=vt,p=this.speedOfSound,w=this.eps,n=0;n!==v;n++){for(c=this.particles[n],i=this.neighbors[n],i.length=0,this.getNeighbors(c,i),i.push(this.particles[n]),s=i.length,l=0,t=0;t!==s;t++)c.position.vsub(i[t].position,y),b=y.norm(),k=this.w(b),l+=i[t].mass*k;this.densities[n]=l;this.pressures[n]=p*p*(this.densities[n]-this.density)}var u=yt,f=pt,h=wt,a=bt,e=kt;for(n=0;n!==v;n++){for(r=this.particles[n],u.set(0,0,0),f.set(0,0,0),i=this.neighbors[n],s=i.length,t=0;t!==s;t++)o=i[t],r.position.vsub(o.position,a),nt=a.norm(),d=-o.mass*(this.pressures[n]/(this.densities[n]*this.densities[n]+w)+this.pressures[t]/(this.densities[t]*this.densities[t]+w)),this.gradw(a,h),h.mult(d,h),u.vadd(h,u),o.velocity.vsub(r.velocity,e),e.mult(1/(.0001+this.densities[n]*this.densities[t])*this.viscosity*o.mass,e),g=this.nablaw(nt),e.mult(g,e),f.vadd(e,f);f.mult(r.mass,f);u.mult(r.mass,u);r.force.vadd(f,r.force);r.force.vadd(u,r.force)}};n.SPHSystem.prototype.w=function(n){var t=this.smoothingRadius;return 315/(64*Math.PI*Math.pow(t,9))*Math.pow(t*t-n*n,3)};n.SPHSystem.prototype.gradw=function(n,t){var r=n.norm(),i=this.smoothingRadius;n.mult(945/(32*Math.PI*Math.pow(i,9))*Math.pow(i*i-r*r,2),t)};n.SPHSystem.prototype.nablaw=function(n){var t=this.smoothingRadius;return 945/(32*Math.PI*Math.pow(t,9))*(t*t-n*n)*(7*n*n-3*t*t)};n.Box=function(t){n.Shape.call(this);this.halfExtents=t;this.type=n.Shape.types.BOX;this.convexPolyhedronRepresentation=null;this.updateConvexPolyhedronRepresentation()};n.Box.prototype=new n.Shape;n.Box.prototype.constructor=n.Box;n.Box.prototype.updateConvexPolyhedronRepresentation=function(){var i=this.halfExtents.x,r=this.halfExtents.y,u=this.halfExtents.z,t=n.Vec3,f=new n.ConvexPolyhedron([new t(-i,-r,-u),new t(i,-r,-u),new t(i,r,-u),new t(-i,r,-u),new t(-i,-r,u),new t(i,-r,u),new t(i,r,u),new t(-i,r,u)],[[3,2,1,0],[4,5,6,7],[5,4,1,0],[2,3,6,7],[0,4,7,3],[1,2,5,6],],[new t(0,0,-1),new t(0,0,1),new t(0,-1,0),new t(0,1,0),new t(-1,0,0),new t(1,0,0)]);this.convexPolyhedronRepresentation=f};n.Box.prototype.calculateLocalInertia=function(t,i){i=i||new n.Vec3;var r=this.halfExtents;return i.x=1/12*t*(4*r.y*r.y+4*r.z*r.z),i.y=1/12*t*(4*r.x*r.x+4*r.z*r.z),i.z=1/12*t*(4*r.y*r.y+4*r.x*r.x),i};n.Box.prototype.getSideNormals=function(n,t){var i=n,r=this.halfExtents,u;if(i[0].set(r.x,0,0),i[1].set(0,r.y,0),i[2].set(0,0,r.z),i[3].set(-r.x,0,0),i[4].set(0,-r.y,0),i[5].set(0,0,-r.z),t!==undefined)for(u=0;u!==i.length;u++)t.vmult(i[u],i[u]);return i};n.Box.prototype.volume=function(){return 8*this.halfExtents.x*this.halfExtents.y*this.halfExtents.z};n.Box.prototype.computeBoundingSphereRadius=function(){this.boundingSphereRadius=this.halfExtents.norm();this.boundingSphereRadiusNeedsUpdate=!1};i=new n.Vec3;dt=new n.Vec3;n.Box.prototype.forEachWorldCorner=function(n,t,r){for(var u=this.halfExtents,e=[[u.x,u.y,u.z],[-u.x,u.y,u.z],[-u.x,-u.y,u.z],[-u.x,-u.y,-u.z],[u.x,-u.y,-u.z],[u.x,u.y,-u.z],[-u.x,u.y,-u.z],[u.x,-u.y,u.z]],f=0;f<e.length;f++)i.set(e[f][0],e[f][1],e[f][2]),t.vmult(i,i),n.vadd(i,i),r(i.x,i.y,i.z)};n.Box.prototype.calculateWorldAABB=function(n,t,i,r){i.set(Infinity,Infinity,Infinity);r.set(-Infinity,-Infinity,-Infinity);this.forEachWorldCorner(n,t,function(n,t,u){n>r.x&&(r.x=n);t>r.y&&(r.y=t);u>r.z&&(r.z=u);n<i.x&&(i.x=n);t<i.y&&(i.y=t);u<i.z&&(i.z=u)})};n.Plane=function(){n.Shape.call(this);this.type=n.Shape.types.PLANE;this.worldNormal=new n.Vec3;this.worldNormalNeedsUpdate=!0};n.Plane.prototype=new n.Shape;n.Plane.prototype.constructor=n.Plane;n.Plane.prototype.computeWorldNormal=function(n){var t=this.worldNormal;t.set(0,0,1);n.vmult(t,t);this.worldNormalNeedsUpdate=!1};n.Plane.prototype.calculateLocalInertia=function(t,i){return i||new n.Vec3};n.Plane.prototype.volume=function(){return Infinity};t=new n.Vec3;n.Plane.prototype.calculateWorldAABB=function(n,i,r,u){t.set(0,0,1);i.vmult(t,t);r.set(-Infinity,-Infinity,-Infinity);u.set(Infinity,Infinity,Infinity);t.x===1&&(u.x=n.x);t.y===1&&(u.y=n.y);t.z===1&&(u.z=n.z);t.x===-1&&(r.x=n.x);t.y===-1&&(r.y=n.y);t.z===-1&&(r.z=n.z)};n.Compound=function(){n.Shape.call(this);this.type=n.Shape.types.COMPOUND;this.childShapes=[];this.childOffsets=[];this.childOrientations=[]};n.Compound.prototype=new n.Shape;n.Compound.prototype.constructor=n.Compound;n.Compound.prototype.addChild=function(t,i,r){i=i||new n.Vec3;r=r||new n.Quaternion;this.childShapes.push(t);this.childOffsets.push(i);this.childOrientations.push(r)};n.Compound.prototype.volume=function(){for(var t=0,i=this.childShapes.length,n=0;n!==i;n++)t+=this.childShapes[n].volume();return t};b=new n.Vec3;k=new n.Vec3;n.Compound.prototype.calculateLocalInertia=function(t,i){var s,e,r,h,o;for(i=i||new n.Vec3,s=this.volume(),e=k,r=0,h=this.childShapes.length;r!==h;r++){var c=this.childShapes[r],u=this.childOffsets[r],l=this.childOrientations[r],f=c.volume()/s*t;c.calculateLocalInertia(f,e);i.vadd(e,i);o=b;o.set(f*u.x*u.x,f*u.y*u.y,f*u.z*u.z);i.vadd(o,i)}return i};n.Compound.prototype.computeBoundingSphereRadius=function(){for(var t,r,i=0,n=0;n<this.childShapes.length;n++)t=this.childShapes[n],t.boundingSphereRadiusNeedsUpdate&&t.computeBoundingSphereRadius(),r=this.childOffsets[n].norm()+t.boundingSphereRadius,i<r&&(i=r);this.boundingSphereRadius=i;this.boundingSphereRadiusNeedsUpdate=!1};var r=new n.Vec3,u=new n.Vec3,e=new n.Vec3,d=new n.Quaternion;n.Compound.prototype.calculateWorldAABB=function(n,t,i,f){var s=this.childShapes.length,o;for(i.set(Infinity,Infinity,Infinity),f.set(-Infinity,-Infinity,-Infinity),o=0;o!==s;o++)this.childOffsets[o].copy(e),t.vmult(e,e),n.vadd(e,e),t.mult(this.childOrientations[o],d),this.childShapes[o].calculateWorldAABB(e,d,u,r),u.x<i.x&&(i.x=u.x),u.y<i.y&&(i.y=u.y),u.z<i.z&&(i.z=u.z),r.x>f.x&&(f.x=r.x),r.y>f.y&&(f.y=r.y),r.z>f.z&&(f.z=r.z)};n.ConvexPolyhedron=function(t,i){function pt(n,t,i,r){t.vsub(n,ut);i.vsub(t,rt);rt.cross(ut,r);r.isZero()||r.normalize()}function lt(n,t,i,r,u){for(var o,h,l=n.vertices.length,f=null,e=null,a=n.vertices,s=0;s<l;s++)a[s].copy(c),r.vmult(c,c),c.vadd(i,c),o=c.dot(t),(f===null||o>f)&&(f=o),(e===null||o<e)&&(e=o);e>f&&(h=e,e=f,f=h);u[0]=f;u[1]=e}function wt(n,t){var i=e.faces[n],r=e.vertices[i[0]],u=e.vertices[i[1]],f=e.vertices[i[2]];return pt(r,u,f,t)}function yt(n){var t=e.faces[n],i=e.faceNormals[n],r=e.vertices[t[0]];return-i.dot(r)}var e=this,rt,ut,h,ot,st,d,r,ft,ht,u,ct,s,et,o,c,b,bt;for(n.Shape.call(this),this.type=n.Shape.types.CONVEXPOLYHEDRON,rt=new n.Vec3,ut=new n.Vec3,this.vertices=t||[],this.worldVertices=[],this.worldVerticesNeedsUpdate=!0,this.faces=i||[],this.faceNormals=[],r=0;r<this.faces.length;r++){for(u=0;u<this.faces[r].length;u++)if(!this.vertices[this.faces[r][u]])throw new Error("Vertex "+this.faces[r][u]+" not found!");if(h=new n.Vec3,wt(r,h),h.negate(h),this.faceNormals.push(h),ot=this.vertices[this.faces[r][0]],h.dot(ot)<0)for(console.warn("Face normal "+r+" ("+h.toString()+") looks like it points into the shape? The vertices follow. Make sure they are ordered CCW around the normal, using the right hand rule."),u=0;u<this.faces[r].length;u++)console.warn("Vertex "+this.faces[r][u]+": ("+this.vertices[i[r][u]].toString()+")")}for(this.worldFaceNormalsNeedsUpdate=!0,this.worldFaceNormals=[],this.uniqueEdges=[],st=this.vertices.length,d=0;d<st;d++){if(o=this.vertices[d],!(o instanceof n.Vec3))throw"Argument 1 must be instance of CANNON.Vec3";this.uniqueEdges.push(o)}for(r=0;r<this.faces.length;r++)for(ft=this.faces[r].length,ht=ft,u=0;u<ht;u++){for(ct=(u+1)%ft,s=new n.Vec3,this.vertices[this.faces[r][u]].vsub(this.vertices[this.faces[r][ct]],s),s.normalize(),et=!1,o=0;o<this.uniqueEdges.length;o++)if(this.uniqueEdges[o].almostEquals(s)||this.uniqueEdges[o].almostEquals(s)){et=!0;break}et||this.uniqueEdges.push(s);s&&(s.face1=r)}c=new n.Vec3;this.testSepAxis=function(n,t,i,r,u,f){var e=[],o=[],y=this;lt(y,n,i,r,e);lt(t,n,u,f,o);var s=e[0],h=e[1],c=o[0],l=o[1];if(s<l||c<h)return!1;var a=s-l,v=c-h;return a<v?a:v};var y=new n.Vec3,p=new n.Vec3,at=new n.Vec3,g=new n.Vec3,nt=new n.Vec3,w=new n.Vec3;this.findSeparatingAxis=function(n,t,i,r,u,f){for(var v,e,b,c,l,a,h=Infinity,o=this,k=0,d=o.faces.length,s=0;s<d;s++){if(o.faceNormals[s].copy(y),i.vmult(y,y),e=o.testSepAxis(y,n,t,i,r,u),e===!1)return!1;e<h&&(h=e,y.copy(f))}for(v=n.faces.length,s=0;s<v;s++){if(n.faceNormals[s].copy(p),u.vmult(p,p),k++,e=o.testSepAxis(p,n,t,i,r,u),e===!1)return!1;e<h&&(h=e,p.copy(f))}for(b=0,c=0;c<o.uniqueEdges.length;c++)for(o.uniqueEdges[c].copy(g),i.vmult(g,g),l=0;l<n.uniqueEdges.length;l++)if(n.uniqueEdges[l].copy(nt),u.vmult(nt,nt),g.cross(nt,w),b++,!w.almostZero()){if(w.normalize(),a=o.testSepAxis(w,n,t,i,r,u),a===!1)return!1;a<h&&(h=a,w.copy(f))}return r.vsub(t,at),at.dot(f)>0&&f.negate(f),!0};b=new n.Vec3;this.clipAgainstHull=function(t,i,r,u,f,e,o,s,h){var l,y,a,d,c;if(!(t instanceof n.Vec3))throw new Error("posA must be Vec3");if(!(i instanceof n.Quaternion))throw new Error("quatA must be Quaternion");var nt=this,tt=s,v=-1,p=-Infinity;for(l=0;l<r.faces.length;l++)r.faceNormals[l].copy(b),f.vmult(b,b),y=b.dot(e),y>p&&(p=y,v=l);var w=[],k=r.faces[v],g=k.length;for(a=0;a<g;a++)d=r.vertices[k[a]],c=new n.Vec3,d.copy(c),f.vmult(c,c),u.vadd(c,c),w.push(c);v>=0&&this.clipFaceAgainstHull(e,t,i,w,o,s,h)};var tt=new n.Vec3,vt=new n.Vec3,l=new n.Vec3,a=new n.Vec3,k=new n.Vec3,v=new n.Vec3,it=new n.Vec3,f=new n.Vec3;this.clipFaceAgainstHull=function(t,i,r,u,e,o,s){var g,et,c,rt,d,ot,lt,at,st,ut,nt,h,b,pt,wt;if(!(t instanceof n.Vec3))throw new Error("sep normal must be vector");if(!(u instanceof Array))throw new Error("world verts must be array");e=Number(e);o=Number(o);var y=this,p=u,ft=[],w=-1,ht=Infinity;for(g=0;g<y.faces.length;g++)y.faceNormals[g].copy(tt),r.vmult(tt,tt),et=tt.dot(t),et<ht&&(ht=et,w=g);if(w<0){console.log("--- did not find any closest face... ---");return}for(c=y.faces[w],c.connectedFaces=[],h=0;h<y.faces.length;h++)for(rt=0;rt<y.faces[h].length;rt++)c.indexOf(y.faces[h][rt])!==-1&&h!==w&&c.connectedFaces.indexOf(h)===-1&&c.connectedFaces.push(h);var bt=p.length,ct=c.length;for(d=0;d<ct;d++){for(ot=y.vertices[c[d]],lt=y.vertices[c[(d+1)%ct]],ot.vsub(lt,vt),vt.copy(l),r.vmult(l,l),i.vadd(l,l),this.faceNormals[w].copy(a),r.vmult(a,a),i.vadd(a,a),l.cross(a,k),k.negate(k),ot.copy(v),r.vmult(v,v),i.vadd(v,v),at=-v.dot(k),st=c.connectedFaces[d],this.faceNormals[st].copy(it),ut=yt(st),it.copy(f),r.vmult(f,f),nt=ut-f.dot(i),this.clipFaceAgainstPlane(p,ft,f,nt);p.length;)p.shift();while(ft.length)p.push(ft.shift())}for(this.faceNormals[w].copy(it),ut=yt(w),it.copy(f),r.vmult(f,f),nt=ut-f.dot(i),h=0;h<p.length;h++)b=f.dot(p[h])+nt,b<=e&&(console.log("clamped: depth="+b+" to minDist="+(e+"")),b=e),b<=o&&(pt=p[h],b<=0&&(wt={point:pt,normal:f,depth:b},s.push(wt)))};this.clipFaceAgainstPlane=function(t,i,r,u){var o,s,l,h,e,c,f;if(!(r instanceof n.Vec3))throw new Error("planeNormal must be Vec3, "+r+" given");if(!(t instanceof Array))throw new Error("invertices must be Array, "+t+" given");if(!(i instanceof Array))throw new Error("outvertices must be Array, "+i+" given");if(l=t.length,l<2)return i;for(h=t[t.length-1],e=t[0],o=r.dot(h)+u,c=0;c<l;c++)e=t[c],s=r.dot(e)+u,o<0?s<0?(f=new n.Vec3,e.copy(f),i.push(f)):(f=new n.Vec3,h.lerp(e,o/(o-s),f),i.push(f)):s<0&&(f=new n.Vec3,h.lerp(e,o/(o-s),f),i.push(f),i.push(e)),h=e,o=s;return i};e=this;this.calculateLocalInertia=function(n,t){e.computeAABB();var i=this.aabbmax.x-this.aabbmin.x,r=this.aabbmax.y-this.aabbmin.y,u=this.aabbmax.z-this.aabbmin.z;t.x=1/12*n*(4*r*r+4*u*u);t.y=1/12*n*(4*i*i+4*u*u);t.z=1/12*n*(4*r*r+4*i*i)};bt=new n.Vec3;this.computeAABB=function(){var u=this.vertices.length,t=this.aabbmin,i=this.aabbmax,f=this.vertices,r,n;for(t.set(Infinity,Infinity,Infinity),i.set(-Infinity,-Infinity,-Infinity),r=0;r<u;r++)n=f[r],n.x<t.x?t.x=n.x:n.x>i.x&&(i.x=n.x),n.y<t.y?t.y=n.y:n.y>i.y&&(i.y=n.y),n.z<t.z?t.z=n.z:n.z>i.z&&(i.z=n.z)}};n.ConvexPolyhedron.prototype=new n.Shape;n.ConvexPolyhedron.prototype.constructor=n.ConvexPolyhedron;n.ConvexPolyhedron.prototype.computeWorldVertices=function(t,i){for(var f=this.vertices.length,e,u,r;this.worldVertices.length<f;)this.worldVertices.push(new n.Vec3);for(e=this.vertices,u=this.worldVertices,r=0;r!==f;r++)i.vmult(e[r],u[r]),t.vadd(u[r],u[r]);this.worldVerticesNeedsUpdate=!1};n.ConvexPolyhedron.prototype.computeWorldFaceNormals=function(t){for(var r=this.faceNormals.length,u,f,i;this.worldFaceNormals.length<r;)this.worldFaceNormals.push(new n.Vec3);for(u=this.faceNormals,f=this.worldFaceNormals,i=0;i!==r;i++)t.vmult(u[i],f[i]);this.worldFaceNormalsNeedsUpdate=!1};n.ConvexPolyhedron.prototype.computeBoundingSphereRadius=function(){for(var i,n=0,r=this.vertices,t=0,u=r.length;t!==u;t++)i=r[t].norm2(),i>n&&(n=i);this.boundingSphereRadius=Math.sqrt(n);this.boundingSphereRadiusNeedsUpdate=!1};f=new n.Vec3;n.ConvexPolyhedron.prototype.calculateWorldAABB=function(n,t,i,r){for(var u,v=this.vertices.length,y=this.vertices,e,o,s,h,c,l,a=0;a<v;a++)y[a].copy(f),t.vmult(f,f),n.vadd(f,f),u=f,u.x<e||e===undefined?e=u.x:(u.x>h||h===undefined)&&(h=u.x),u.y<o||o===undefined?o=u.y:(u.y>c||c===undefined)&&(c=u.y),u.z<s||s===undefined?s=u.z:(u.z>l||l===undefined)&&(l=u.z);i.set(e,o,s);r.set(h,c,l)};n.ConvexPolyhedron.prototype.volume=function(){return this.boundingSphereRadiusNeedsUpdate&&this.computeBoundingSphereRadius(),4*Math.PI*this.boundingSphereRadius/3};n.ConvexPolyhedron.prototype.getAveragePointLocal=function(t){var r,u,i;for(t=t||new n.Vec3,r=this.vertices.length,u=this.vertices,i=0;i<r;i++)t.vadd(u[i],t);return t.mult(1/r,t),t};n.ConvexPolyhedron.prototype.transformAllPoints=function(n,t){var u=this.vertices.length,f=this.vertices,i,r;if(t){for(i=0;i<u;i++)r=f[i],t.vmult(r,r);for(i=0;i<this.faceNormals.length;i++)r=this.faceNormals[i],t.vmult(r,r)}if(n)for(i=0;i<u;i++)r=f[i],r.vadd(n,r)};var gt=new n.Vec3,ni=new n.Vec3,ti=new n.Vec3;n.ConvexPolyhedron.prototype.pointIsInside=function(n){var f=this.vertices.length,h=this.vertices,c=this.faces,l=this.faceNormals,a=this.faces.length,e=gt,t,i,r,u;for(this.getAveragePointLocal(e),t=0;t<a;t++){var v=this.faces[t].length,f=l[t],o=h[c[t][0]],s=ni;if(n.vsub(o,s),i=f.dot(s),r=ti,e.vsub(o,r),u=f.dot(r),i<0&&u>0||i>0&&u<0)return!1}return-1};n.Cylinder=function(t,i,r,u){var y=u,s=[],h=[],c=[],l=[],p=[],e=Math.cos,o=Math.sin,a,v,w,f;for(s.push(new n.Vec3(i*e(0),i*o(0),-r*.5)),l.push(0),s.push(new n.Vec3(t*e(0),t*o(0),r*.5)),p.push(1),f=0;f<y;f++)a=2*Math.PI/y*(f+1),v=2*Math.PI/y*(f+.5),f<y-1?(s.push(new n.Vec3(i*e(a),i*o(a),-r*.5)),l.push(2*f+2),s.push(new n.Vec3(t*e(a),t*o(a),r*.5)),p.push(2*f+3),h.push(new n.Vec3(e(v),o(v),0)),c.push([2*f+2,2*f+3,2*f+1,2*f])):(c.push([0,1,2*f+1,2*f]),h.push(new n.Vec3(e(v),o(v),0)));for(c.push(p),h.push(new n.Vec3(0,0,1)),w=[],f=0;f<l.length;f++)w.push(l[l.length-f-1]);c.push(w);h.push(new n.Vec3(0,0,-1));this.type=n.Shape.types.CONVEXPOLYHEDRON;n.ConvexPolyhedron.call(this,s,c,h)};n.Cylinder.prototype=new n.ConvexPolyhedron;n.Ray=function(t,i){function rt(n,t,i){return i.vsub(n,u),tt=u.dot(t),t.mult(tt,c),c.vadd(n,c),it=i.distanceTo(c)}function ut(n,t,i,r){return r.vsub(t,u),i.vsub(t,h),n.vsub(t,a),p=u.dot(u),l=u.dot(h),w=u.dot(a),b=h.dot(h),k=h.dot(a),d=1/(p*b-l*l),g=(b*w-l*k)*d,nt=(p*k-l*w)*d,g>=0&&nt>=0&&g+nt<1}var v,u,c,tt,it,p,l,w,b,k,d,g,nt,h,a;this.origin=t||new n.Vec3;this.direction=i||new n.Vec3;v=.0001;this.setPrecision=function(n){v=n};var f=new n.Vec3,e=new n.Vec3,o=new n.Vec3,ft=new n.Vec3,et=new n.Vec3,r=new n.Vec3,y=new n.Vec3,s=new n.Vec3;this.intersectBody=function(t){if(t.shape instanceof n.ConvexPolyhedron)return this.intersectShape(t.shape,t.quaternion,t.position,t);if(t.shape instanceof n.Box)return this.intersectShape(t.shape.convexPolyhedronRepresentation,t.quaternion,t.position,t);console.warn("Ray intersection is this far only implemented for ConvexPolyhedron and Box shapes.")};this.intersectShape=function(t,i,u,h){var nt,d=[],tt,l,p;if(t instanceof n.ConvexPolyhedron){if(tt=rt(this.origin,this.direction,u),tt>t.getBoundingSphereRadius())return d;var w,g,it=t.faces,b=t.vertices,ft=t.faceNormals;for(l=0;l<it.length;l++){var c=it[l],et=ft[l],a=i,k=u;if((b[c[0]].copy(r),a.vmult(r,r),r.vadd(k,r),r.vsub(this.origin,r),a.vmult(et,y),w=this.direction.dot(y),!(Math.abs(w)<v))&&(g=y.dot(r)/w,!(g<0))&&w<0)for(this.direction.mult(g,s),s.vadd(this.origin,s),b[c[0]].copy(f),a.vmult(f,f),k.vadd(f,f),p=1;p<c.length-1;p++)if(b[c[p]].copy(e),b[c[p+1]].copy(o),a.vmult(e,e),a.vmult(o,o),k.vadd(e,e),k.vadd(o,o),ut(s,f,e,o)){nt={distance:this.origin.distanceTo(s),point:s.copy(),face:c,body:h};d.push(nt);break}}}return d};this.intersectBodies=function(n){for(var r,t=[],i=0,u=n.length;i<u;i++)r=this.intersectBody(n[i]),Array.prototype.push.apply(t,r);return t.sort(function(n,t){return n.distance-t.distance}),t};u=new n.Vec3;c=new n.Vec3;h=new n.Vec3;a=new n.Vec3};n.Ray.prototype.constructor=n.Ray;n.Broadphase=function(){this.world=null;this.useBoundingBoxes=!1};n.Broadphase.prototype.constructor=n.BroadPhase;n.Broadphase.prototype.collisionPairs=function(){throw new Error("collisionPairs not implemented for this BroadPhase class!");};h=n.Body.STATIC|n.Body.KINEMATIC;n.Broadphase.prototype.needBroadphaseCollision=function(t,i){return(t.collisionFilterGroup&i.collisionFilterMask)==0||(i.collisionFilterGroup&t.collisionFilterMask)==0?!1:((t.motionstate&h)!=0||t.isSleeping())&&((i.motionstate&h)!=0||i.isSleeping())?!1:!t.shape&&!i.shape?!1:t.shape instanceof n.Plane&&i.shape instanceof n.Plane?!1:!0};n.Broadphase.prototype.intersectionTest=function(n,t,i,r){this.useBoundingBoxes?this.doBoundingBoxBroadphase(n,t,i,r):this.doBoundingSphereBroadphase(n,t,i,r)};var ii=new n.Vec3,ri=new n.Vec3,ui=new n.Quaternion,fi=new n.Vec3;n.Broadphase.prototype.doBoundingSphereBroadphase=function(t,i,r,u){var f=n.Shape.types,p=f.SPHERE|f.BOX|f.COMPOUND|f.CONVEXPOLYHEDRON,it=f.PLANE,ft=n.Body.STATIC|n.Body.KINEMATIC,w=ii,h=ri,et=ui,c=fi,o=t.shape,l=i.shape,a,b,k,ut,nt,tt;if(o&&l){if(a=o.type,b=l.type,a&p&&b&p)i.position.vsub(t.position,w),o.boundingSphereRadiusNeedsUpdate&&o.computeBoundingSphereRadius(),l.boundingSphereRadiusNeedsUpdate&&l.computeBoundingSphereRadius(),k=o.boundingSphereRadius+l.boundingSphereRadius,w.norm2()<k*k&&(r.push(t),u.push(i));else if(a&p&&b&f.PLANE||b&p&&a&f.PLANE){var d=a===it?t:i,rt=a!==it?t:i,e=rt.shape,g=d.shape;rt.position.vsub(d.position,w);g.worldNormalNeedsUpdate&&g.computeWorldNormal(d.quaternion);h=g.worldNormal;e.boundingSphereRadiusNeedsUpdate&&e.computeBoundingSphereRadius();ut=w.dot(h)-e.boundingSphereRadius;ut<0&&(r.push(t),u.push(i))}}else if(o||l){var v=o?i:t,s=o?t:i,e=s.shape,y=e.type;y&p?y===f.SPHERE?(v.position.vsub(s.position,c),e.radius*e.radius>=c.norm2()&&(r.push(v),u.push(s))):(y===f.CONVEXPOLYHEDRON||y===f.BOX||y===f.COMPOUND)&&(e.boundingSphereRadiusNeedsUpdate&&e.computeBoundingSphereRadius(),nt=e.boundingSphereRadius,v.position.vsub(s.position,c),nt*nt>=c.norm2()&&(r.push(v),u.push(s))):y===f.PLANE&&(tt=s,h.set(0,0,1),tt.quaternion.vmult(h,h),v.position.vsub(tt.position,c),h.dot(c)<=0&&(r.push(v),u.push(s)))}};n.Broadphase.prototype.doBoundingBoxBroadphase=function(t,i,r,u){var o=t.shape,s=i.shape,e,f;t.aabbNeedsUpdate&&t.computeAABB();i.aabbNeedsUpdate&&i.computeAABB();o&&s?t.aabbmax.x<i.aabbmin.x||t.aabbmax.y<i.aabbmin.y||t.aabbmax.z<i.aabbmin.z||t.aabbmin.x>i.aabbmax.x||t.aabbmin.y>i.aabbmax.y||t.aabbmin.z>i.aabbmax.z||(r.push(t),u.push(i)):(o||s)&&(e=o?i:t,f=o?t:i,f.shape instanceof n.Plane,e.position.x<f.aabbmin.x||e.position.y<f.aabbmin.y||e.position.z<f.aabbmin.z||e.position.x>f.aabbmax.x||e.position.y>f.aabbmax.y||e.position.z>f.aabbmax.z||(r.push(t),u.push(i)))};var ei={},oi=[],si=[];n.Broadphase.prototype.makePairsUnique=function(n,t){for(var u,r=ei,f=oi,e=si,h=n.length,i=0;i!==h;i++)f[i]=n[i],e[i]=t[i];for(n.length=0,t.length=0,i=0;i!==h;i++){var o=f[i].id,s=e[i].id,u=o<s?o+","+s:s+","+o;r[u]=i}for(u in r)i=r[u],n.push(f[i]),t.push(e[i]),delete r[u]};n.NaiveBroadphase=function(){n.Broadphase.apply(this)};n.NaiveBroadphase.prototype=new n.Broadphase;n.NaiveBroadphase.prototype.constructor=n.NaiveBroadphase;n.NaiveBroadphase.prototype.collisionPairs=function(n,t,i){for(var f=n.bodies,s=f.length,u,e,o,r=0;r!==s;r++)for(u=0;u!==r;u++)(e=f[r],o=f[u],this.needBroadphaseCollision(e,o))&&this.intersectionTest(e,o,t,i)};n.GridBroadphase=function(t,i,r,u,f){n.Broadphase.apply(this);this.nx=r||10;this.ny=u||10;this.nz=f||10;this.aabbMin=t||new n.Vec3(100,100,100);this.aabbMax=i||new n.Vec3(-100,-100,-100);this.bins=[]};n.GridBroadphase.prototype=new n.Broadphase;n.GridBroadphase.prototype.constructor=n.GridBroadphase;g=new n.Vec3;nt=new n.Vec3;n.GridBroadphase.prototype.collisionPairs=function(t,i,r){for(var c,l,h,d,rt,f,ri,e,o,at,ui=t.numObjects(),fi=t.bodies,ut=this.aabbMax,ft=this.aabbMin,tt=this.nx,a=this.ny,s=this.nz,vt=ut.x,yt=ut.y,pt=ut.z,p=ft.x,w=ft.y,b=ft.z,wt=tt/(vt-p),bt=a/(yt-w),kt=s/(pt-b),et=(vt-p)/tt,ot=(yt-w)/a,st=(pt-b)/s,k=n.Shape.types,ei=k.SPHERE,oi=k.PLANE,wi=k.BOX,bi=k.COMPOUND,ki=k.CONVEXPOLYHEDRON,v=this.bins,it=tt*a*s,u=v.length-1;u!==it;u++)v.push([]);for(u=0;u!==it;u++)v[u].length=0;for(c=Math.floor,u=0;u!==ui;u++){e=fi[u];l=e.shape;switch(l.type){case ei:var dt=e.position.x,gt=e.position.y,ni=e.position.z,y=l.radius,si=c(wt*(dt-y-p)),hi=c(bt*(gt-y-w)),ci=c(kt*(ni-y-b)),li=c(wt*(dt+y-p)),ai=c(bt*(gt+y-w)),vi=c(kt*(ni+y-b));for(f=si;f!==li+1;f++)for(o=hi;o!==ai+1;o++)for(h=ci;h!==vi+1;h++){var ht=f,ct=o,lt=h,d=ht*(a-1)*(s-1)+ct*(s-1)+lt;d>=0&&d<it&&v[d].push(e)}break;case oi:var ti=g,ii=nt,yi=(et*et+ot*ot+st*st)*.25,pi=l.worldNormal;for(l.worldNormalNeedsUpdate&&l.computeWorldNormal(e.quaternion),f=0;f!==tt;f++)for(o=0;o!==a;o++)for(h=0;h!==s;h++){var ht=f,ct=o,lt=h;ii.set(ht*et+p,ct*ot+w,lt*st+b);ii.vsub(e.position,ti);ti.dot(pi)<yi&&(d=ht*(a-1)*(s-1)+ct*(s-1)+lt,v[d].push(e))}break;default:console.warn("Shape "+l.type+" not supported in GridBroadphase!")}}for(u=0;u!==it;u++)for(rt=v[u],f=0,ri=rt.length;f!==ri;f++)for(e=rt[f],o=0;o!==f;o++)at=rt[o],this.needBroadphaseCollision(e,at)&&this.intersectionTest(e,at,i,r);this.makePairsUnique(i,r)};n.Solver=function(){this.equations=[]};n.Solver.prototype.solve=function(){return 0};n.Solver.prototype.addEquation=function(n){this.equations.push(n)};n.Solver.prototype.removeEquation=function(n){var t=this.equations,i=t.indexOf(n);i!==-1&&t.splice(i,1)};n.Solver.prototype.removeAllEquations=function(){this.equations.length=0};n.GSSolver=function(){n.Solver.call(this);this.iterations=10;this.tolerance=0};n.GSSolver.prototype=new n.Solver;var hi=[],ci=[],li=[];n.GSSolver.prototype.solve=function(n,t){var et=this.d,ot=this.k,s=0,rt=this.iterations,ut=this.tolerance*this.tolerance,st=this.a,e=this.b,l=this.equations,a=l.length,v=t.bodies,b=v.length,k=n,d,g,u,h,nt,o,y=ci,p=li,c=hi,f,r,i;for(y.length=0,p.length=0,c.length=0,i=0;i!==a;i++)r=l[i],r.spookParamsNeedsUpdate&&(r.updateSpookParams(k),r.spookParamsNeedsUpdate=!1),c[i]=0,p[i]=r.computeB(k),y[i]=1/r.computeC();if(a!==0){for(i=0;i!==b;i++){var e=v[i],ft=e.vlambda,tt=e.wlambda;ft.set(0,0,0);tt&&tt.set(0,0,0)}for(s=0;s!==rt;s++){for(h=0,f=0;f!==a;f++)r=l[f],d=p[f],g=y[f],o=c[f],nt=r.computeGWlambda(),u=g*(d-nt-r.eps*o),o+u<r.minForce?u=r.minForce-o:o+u>r.maxForce&&(u=r.maxForce-o),c[f]+=u,h+=u>0?u:-u,r.addToWlambda(u);if(h*h<ut)break}for(i=0;i!==b;i++){var e=v[i],it=e.velocity,w=e.angularVelocity;it.vadd(e.vlambda,it);w&&w.vadd(e.wlambda,w)}}return s};n.SplitSolver=function(t){n.Solver.call(this);this.subsolver=t};n.SplitSolver.prototype=new n.Solver;var ai=[],vi=[],yi=[],pi={bodies:null};n.SplitSolver.prototype.solve=function(t,i){function k(n){for(var t,r=n.length,i=0;i!==r;i++)if(t=n[i],!t.visited&&!(t.body.motionstate&b))return t;return!1}function rt(n,t){var i=[],u,r;for(i.push(n),n.visited=!0,t(n);i.length;)for(u=i.pop();r=k(u.children);)r.visited=!0,t(r),i.push(r)}function ut(n){var r,t,i;for(v.push(n.body),r=n.eqs.length,t=0;t!==r;t++)i=n.eqs[t],o.indexOf(i)===-1&&o.push(i)}for(var e,s,b,y,nt,ft,u=ai,f=i.bodies,p=this.equations,tt=p.length,w=f.length,c=this.subsolver,r=u.length;r!==w;r++)u.push({body:f[r],children:[],eqs:[],visited:!1});for(r=0;r!==w;r++)e=u[r],e.body=f[r],e.children.length=0,e.eqs.length=0,e.visited=!1;for(s=0;s!==tt;s++){var h=p[s],r=f.indexOf(h.bi),it=f.indexOf(h.bj),l=u[r],a=u[it];l.children.push(a);l.eqs.push(h);a.children.push(l);a.eqs.push(h)}b=n.Body.STATIC;var d,g=0,o=vi,v=yi;for(y=pi;d=k(u);){for(o.length=0,v.length=0,rt(d,ut),nt=o.length,r=0;r!==nt;r++)c.addEquation(o[r]);y.bodies=v;ft=c.solve(t,y);c.removeAllEquations();g++}return g};n.Material=function(n){this.name=n;this.id=-1};n.ContactMaterial=function(n,t,i,r){this.id=-1;this.materials=[n,t];this.friction=i!==undefined?Number(i):.3;this.restitution=r!==undefined?Number(r):.3;this.contactEquationStiffness=1e7;this.contactEquationRegularizationTime=3;this.frictionEquationStiffness=1e7;this.frictionEquationRegularizationTime=3};n.World=function(){n.EventTarget.apply(this);this.allowSleep=!1;this.contacts=[];this.frictionEquations=[];this.quatNormalizeSkip=0;this.quatNormalizeFast=!1;this.time=0;this.stepnumber=0;this.default_dt=1/60;this.last_dt=this.default_dt;this.nextId=0;this.gravity=new n.Vec3;this.broadphase=null;this.bodies=[];var t=this;this.solver=new n.GSSolver;this.constraints=[];this.contactgen=new n.ContactGenerator;this.collisionMatrix=[];this.collisionMatrixPrevious=[];this.materials=[];this.contactmaterials=[];this.mats2cmat=[];this.defaultMaterial=new n.Material("default");this.defaultContactMaterial=new n.ContactMaterial(this.defaultMaterial,this.defaultMaterial,.3,0);this.doProfiling=!1;this.profile={solve:0,makeContactConstraints:0,broadphase:0,integrate:0,nearphase:0};this.subsystems=[]};n.World.prototype.getContactMaterial=function(t,i){var r,u,f;if(t instanceof n.Material&&i instanceof n.Material)return r=t.id,u=i.id,r<u&&(f=r,r=u,u=f),this.contactmaterials[this.mats2cmat[r+u*this.materials.length]]};n.World.prototype.numObjects=function(){return this.bodies.length};n.World.prototype.collisionMatrixGet=function(n,t,i){if(t>n){var r=t;t=n;n=r}return n=(n*(n+1)>>1)+t-1,typeof i=="undefined"||i?this.collisionMatrix[n]:this.collisionMatrixPrevious[n]};n.World.prototype.collisionMatrixSet=function(n,t,i,r){if(t>n){var u=t;t=n;n=u}n=(n*(n+1)>>1)+t-1;typeof r=="undefined"||r?this.collisionMatrix[n]=i:this.collisionMatrixPrevious[n]=i};n.World.prototype.collisionMatrixTick=function(){var i=this.collisionMatrixPrevious,n,t;for(this.collisionMatrixPrevious=this.collisionMatrix,this.collisionMatrix=i,n=0,t=this.collisionMatrix.length;n!==t;n++)this.collisionMatrix[n]=0};n.World.prototype.add=function(t){t.id=this.id();t.index=this.bodies.length;this.bodies.push(t);t.world=this;t.position.copy(t.initPosition);t.velocity.copy(t.initVelocity);t.timeLastSleepy=this.time;t instanceof n.RigidBody&&(t.angularVelocity.copy(t.initAngularVelocity),t.quaternion.copy(t.initQuaternion));var i=this.numObjects();this.collisionMatrix.length=i*(i-1)>>1};n.World.prototype.addConstraint=function(n){this.constraints.push(n);n.id=this.id()};n.World.prototype.removeConstraint=function(n){var t=this.constraints.indexOf(n);t!==-1&&this.constraints.splice(t,1)};n.World.prototype.id=function(){return this.nextId++};n.World.prototype.remove=function(n){var i,r,t;for(n.world=null,i=this.numObjects()-1,r=this.bodies,r.splice(n.index,1),t=n.index;t<i;t++)r[t].index=t;this.collisionMatrixPrevious.length=this.collisionMatrix.length=i*(i-1)>>1};n.World.prototype.addMaterial=function(n){var i,t;if(n.id===-1)for(i=this.materials.length,this.materials.push(n),n.id=this.materials.length-1,t=0;t!==2*i+1;t++)this.mats2cmat.push(-1)};n.World.prototype.addContactMaterial=function(n){this.addMaterial(n.materials[0]);this.addMaterial(n.materials[1]);var t,i;n.materials[0].id>n.materials[1].id?(t=n.materials[0].id,i=n.materials[1].id):(i=n.materials[0].id,t=n.materials[1].id);this.contactmaterials.push(n);n.id=this.contactmaterials.length-1;this.mats2cmat[t+this.materials.length*i]=n.id};n.World.prototype._now=function(){return window.performance.webkitNow?window.performance.webkitNow():Date.now()};var tt={type:"postStep"},s={type:"collide","with":null,contact:null},wi=[],bi=[],ki=[],di=[],gi=new n.Vec3,ar=new n.Vec3,vr=new n.Vec3,yr=new n.Vec3,pr=new n.Vec3,wr=new n.Vec3,br=new n.Vec3,kr=new n.Vec3,dr=new n.Vec3,nr=new n.Quaternion,tr=new n.Quaternion,ir=new n.Quaternion;n.World.prototype.step=function(t){var kr=this,dr=this,k=this.contacts,yt=ki,pt=di,p=this.numObjects(),l=this.bodies,d=this.solver,ot=this.gravity,o=this.doProfiling,it=this.profile,fi=n.Body.DYNAMIC,h=this._now,c,ei=this.constraints,oi=n.FrictionEquation,si=bi,sr=ot.norm(),hr=ot.x,cr=ot.y,lr=ot.z,i=0,st,ht,hi,wt,ci,li,ai,ct,bt,ut,y,pi,f,w,rr,ur,kt,fr,dt,at,er,r,ui,u;for(o&&(c=h()),t===undefined&&(t=this.last_dt||this.default_dt),i=0;i!==p;i++)r=l[i],r.motionstate&fi&&(st=r.force,ht=r.mass,st.x+=ht*hr,st.y+=ht*cr,st.z+=ht*lr);for(i=0,hi=this.subsystems.length;i!==hi;i++)this.subsystems[i].update();for(o&&(c=h()),yt.length=0,pt.length=0,this.broadphase.collisionPairs(this,yt,pt),o&&(it.broadphase=h()-c),this.collisionMatrixTick(),o&&(c=h()),wt=wi,ci=k.length,i=0;i!==ci;i++)wt.push(k[i]);for(k.length=0,this.contactgen.getContacts(yt,pt,this,k,wt),o&&(it.nearphase=h()-c),o&&(c=h()),li=k.length,ai=this.frictionEquations.length,i=0;i!==ai;i++)si.push(this.frictionEquations[i]);for(this.frictionEquations.length=0,ct=0;ct!==li;ct++){var f=k[ct],r=f.bi,e=f.bj,i=l.indexOf(r),w=l.indexOf(e),rt=this.getContactMaterial(r.material,e.material)||this.defaultContactMaterial,vi=rt.friction,gr=rt.restitution,yi=gi;if(yi.set(e.position.x+f.rj.x-r.position.x-f.ri.x,e.position.y+f.rj.y-r.position.y-f.ri.y,e.position.z+f.rj.z-r.position.z-f.ri.z),bt=yi.dot(f.ni),bt<0){if(f.restitution=rt.restitution,f.penetration=bt,f.stiffness=rt.contactEquationStiffness,f.regularizationTime=rt.contactEquationRegularizationTime,d.addEquation(f),vi>0){ut=vi*sr;y=r.invMass+e.invMass;y>0&&(y=1/y);var lt=si,a=lt.length?lt.pop():new oi(r,e,ut*y),v=lt.length?lt.pop():new oi(r,e,ut*y);this.frictionEquations.push(a);this.frictionEquations.push(v);a.bi=v.bi=r;a.bj=v.bj=e;a.minForce=v.minForce=-ut*y;a.maxForce=v.maxForce=ut*y;f.ri.copy(a.ri);f.rj.copy(a.rj);f.ri.copy(v.ri);f.rj.copy(v.rj);f.ni.tangents(a.t,v.t);d.addEquation(a);d.addEquation(v)}this.collisionMatrixSet(i,w,1,!0);this.collisionMatrixGet(i,w,!0)!==this.collisionMatrixGet(i,w,!1)&&(s.with=e,s.contact=f,r.dispatchEvent(s),s.with=r,e.dispatchEvent(s),r.wakeUp(),e.wakeUp())}}for(o&&(it.makeContactConstraints=h()-c),o&&(c=h()),pi=ei.length,i=0;i!==pi;i++)for(f=ei[i],f.update(),w=0,rr=f.equations.length;w!==rr;w++)ur=f.equations[w],d.addEquation(ur);for(d.solve(t,this),o&&(it.solve=h()-c),d.removeAllEquations(),kt=Math.pow,i=0;i!==p;i++)r=l[i],r.motionstate&fi&&(fr=kt(1-r.linearDamping,t),dt=r.velocity,dt.mult(fr,dt),at=r.angularVelocity,at&&(er=kt(1-r.angularDamping,t),at.mult(er,at)));for(this.dispatchEvent(tt),i=0;i!==p;i++)r=l[i],r.preStep&&r.preStep.call(r);o&&(c=h());var nu=nr,or=tr,ft=ir,ar=this.stepnumber,vr=n.Body.DYNAMIC|n.Body.KINEMATIC,yr=ar%(this.quatNormalizeSkip+1)==0,pr=this.quatNormalizeFast,vt=t*.5,wr=n.Shape.types.PLANE,br=n.Shape.types.CONVEXPOLYHEDRON;for(i=0;i!==p;i++){var u=l[i],et=u.shape,gt=u.force,ni=u.tau;if(u.motionstate&vr){var g=u.velocity,nt=u.angularVelocity,ti=u.position,b=u.quaternion,ii=u.invMass,ri=u.invInertia;if(g.x+=gt.x*ii*t,g.y+=gt.y*ii*t,g.z+=gt.z*ii*t,u.angularVelocity&&(nt.x+=ni.x*ri.x*t,nt.y+=ni.y*ri.y*t,nt.z+=ni.z*ri.z*t),u.isSleeping()||(ti.x+=g.x*t,ti.y+=g.y*t,ti.z+=g.z*t,u.angularVelocity&&(or.set(nt.x,nt.y,nt.z,0),or.mult(b,ft),b.x+=vt*ft.x,b.y+=vt*ft.y,b.z+=vt*ft.z,b.w+=vt*ft.w,yr&&(pr?b.normalizeFast():b.normalize())),u.aabbmin&&(u.aabbNeedsUpdate=!0)),et)switch(et.type){case wr:et.worldNormalNeedsUpdate=!0;break;case br:et.worldFaceNormalsNeedsUpdate=!0;et.worldVerticesNeedsUpdate=!0}}u.force.set(0,0,0);u.tau&&u.tau.set(0,0,0)}for(o&&(it.integrate=h()-c),this.time+=t,this.stepnumber+=1,this.dispatchEvent(tt),i=0;i!==p;i++)r=l[i],ui=r.postStep,ui&&ui.call(r);for(i=0;i!==p;i++)u=l[i],u.inertiaWorldAutoUpdate&&u.quaternion.vmult(u.inertia,u.inertiaWorld),u.invInertiaWorldAutoUpdate&&u.quaternion.vmult(u.invInertia,u.invInertiaWorld);if(this.allowSleep)for(i=0;i!==p;i++)l[i].sleepTick(this.time)};n.ContactGenerator=function(){function i(t,i){if(u.length){var r=u.pop();return r.bi=t,r.bj=i,r}return new n.ContactEquation(t,i)}function h(n){var t;t=n.ri;n.ri=n.rj;n.rj=t;n.ni.negate(n.ni);t=n.bi;n.bi=n.bj;n.bj=t}function d(n,t,r,u,f,e,o,s,h){var c=i(s,h);h.position.vsub(u,c.ni);c.ni.normalize();c.ni.copy(c.ri);c.ni.copy(c.rj);c.ri.mult(t.radius,c.ri);c.rj.mult(-r.radius,c.rj);n.push(c)}function g(n,t,r,u,o,s,h,c,l){var a=i(c,l);a.ni.set(0,0,1);h.vmult(a.ni,a.ni);a.ni.negate(a.ni);a.ni.normalize();a.ni.mult(t.radius,a.ri);u.vsub(o,f);a.ni.mult(a.ni.dot(f),e);f.vsub(e,a.rj);e.norm2()<=t.radius*t.radius&&n.push(a)}function rt(n,t,i){for(var e,o,s,h,f,r=null,c=n.length,u=0;u!==c;u++)if(e=n[u],o=nt,n[(u+1)%c].vsub(e,o),s=tt,o.cross(t,s),h=it,i.vsub(e,h),f=s.dot(h),r===null||f>0&&r===!0||f<=0&&r===!1){r===null&&(r=f>0);continue}else return!1;return!0}function at(n,r,u,f,e,s,h,c,l){var y=ot,it,li,rt,dt,gt,at,vt,ui,fi,ni,ti,w,v,yt,a,b,k,ei,g,vi,yi,p;f.vsub(e,o);u.getSideNormals(y,h);var nt=r.radius,d=!1,tt=ht,bt=ct,kt=lt,oi=null,si=0,hi=0,ci=0,ri=null;for(it=0,li=y.length;it!==li&&d===!1;it++)rt=ut,y[it].copy(rt),dt=rt.norm(),rt.normalize(),gt=o.dot(rt),gt<dt+nt&&gt>0&&(at=ft,vt=et,y[(it+1)%3].copy(at),y[(it+2)%3].copy(vt),ui=at.norm(),fi=vt.norm(),at.normalize(),vt.normalize(),ni=o.dot(at),ti=o.dot(vt),ni<ui&&ni>-ui&&ti<fi&&ti>-fi&&(w=Math.abs(gt-dt-nt),(ri===null||w<ri)&&(ri=w,hi=ni,ci=ti,oi=dt,rt.copy(tt),at.copy(bt),vt.copy(kt),si++)));for(si&&(d=!0,a=i(c,l),tt.mult(-nt,a.ri),tt.copy(a.ni),a.ni.negate(a.ni),tt.mult(oi,tt),bt.mult(hi,bt),tt.vadd(bt,tt),kt.mult(ci,kt),tt.vadd(kt,a.rj),n.push(a)),v=t.get(),yt=st,b=0;b!==2&&!d;b++)for(k=0;k!==2&&!d;k++)for(g=0;g!==2&&!d;g++)v.set(0,0,0),b?v.vadd(y[0],v):v.vsub(y[0],v),k?v.vadd(y[1],v):v.vsub(y[1],v),g?v.vadd(y[2],v):v.vsub(y[2],v),e.vadd(v,yt),yt.vsub(f,yt),yt.norm2()<nt*nt&&(d=!0,a=i(c,l),yt.copy(a.ri),a.ri.normalize(),a.ri.copy(a.ni),a.ri.mult(nt,a.ri),v.copy(a.rj),n.push(a));t.release(v);v=null;var pt=t.get(),wt=t.get(),a=t.get(),ii=t.get(),w=t.get(),ai=y.length;for(b=0;b!==ai&&!d;b++)for(k=0;k!==ai&&!d;k++)if(b%3!=k%3){for(y[k].cross(y[b],pt),pt.normalize(),y[b].vadd(y[k],wt),f.copy(a),a.vsub(wt,a),a.vsub(e,a),ei=a.dot(pt),pt.mult(ei,ii),g=0;g===b%3||g===k%3;)g++;f.copy(w);w.vsub(ii,w);w.vsub(wt,w);w.vsub(e,w);vi=Math.abs(ei);yi=w.norm();vi<y[g].norm()&&yi<nt&&(d=!0,p=i(c,l),wt.vadd(ii,p.rj),p.rj.copy(p.rj),w.negate(p.ni),p.ni.normalize(),p.rj.copy(p.ri),p.ri.vadd(e,p.ri),p.ri.vsub(f,p.ri),p.ri.normalize(),p.ri.mult(nt,p.ri),n.push(p))}t.release(pt,wt,a,ii,w)}function ii(n,r,u,f,e,o,s,h,c){var hi,tt,ct,lt,y,ci,it,ft,fi,ei,oi,w,li,et,at,ii,b,g,ri,ui,k,ot,st,ht,l,a,ut;f.vsub(e,vt);var ai=u.faceNormals,si=u.faces,nt=u.vertices,v=r.radius;for(y=0;y!==nt.length;y++)if(hi=nt[y],tt=bt,s.vmult(hi,tt),e.vadd(tt,tt),ct=wt,tt.vsub(f,ct),ct.norm2()<v*v){lt=!0;l=i(h,c);ct.copy(l.ri);l.ri.normalize();l.ri.copy(l.ni);l.ri.mult(v,l.ri);tt.vsub(e,l.rj);n.push(l);return}for(lt=!1,y=0,ci=si.length;y!==ci&&lt===!1;y++){var vi=ai[y],d=si[y],p=kt;if(s.vmult(vi,p),it=dt,s.vmult(nt[d[0]],it),it.vadd(e,it),ft=gt,p.mult(-v,ft),f.vadd(ft,ft),fi=ni,ft.vsub(it,fi),ei=fi.dot(p),oi=ti,f.vsub(it,oi),ei<0&&oi.dot(p)>0){for(w=[],a=0,li=d.length;a!==li;a++)et=t.get(),s.vmult(nt[d[a]],et),e.vadd(et,et),w.push(et);if(rt(w,p,f)){for(lt=!0,l=i(h,c),p.mult(-v,l.ri),p.negate(l.ni),at=t.get(),p.mult(-ei,at),ii=t.get(),p.mult(-v,ii),f.vsub(e,l.rj),l.rj.vadd(ii,l.rj),l.rj.vadd(at,l.rj),t.release(at),t.release(ii),n.push(l),a=0,ut=w.length;a!==ut;a++)t.release(w[a]);return}for(a=0;a!==d.length;a++){if(b=t.get(),g=t.get(),s.vmult(nt[d[(a+1)%d.length]],b),s.vmult(nt[d[(a+2)%d.length]],g),e.vadd(b,b),e.vadd(g,g),ri=yt,g.vsub(b,ri),ui=pt,ri.unit(ui),k=t.get(),ot=t.get(),f.vsub(b,ot),st=ot.dot(ui),ui.mult(st,k),k.vadd(b,k),ht=t.get(),k.vsub(f,ht),st>0&&st*st<ri.norm2()&&ht.norm2()<v*v){for(l=i(h,c),k.vsub(e,l.rj),k.vsub(f,l.ni),l.ni.normalize(),l.ni.mult(v,l.ri),n.push(l),a=0,ut=w.length;a!==ut;a++)t.release(w[a]);t.release(b);t.release(g);t.release(k);t.release(ht);t.release(ot);return}t.release(b);t.release(g);t.release(k);t.release(ht);t.release(ot)}for(a=0,ut=w.length;a!==ut;a++)t.release(w[a])}}}function fi(n,t,i,r,u,f,e,o,s){a(n,t,i.convexPolyhedronRepresentation,r,u,f,e,o,s)}function r(t,i,r,u,f,e,o,h,a){for(var k,w,d=c,g=l,nt=0,v=0,tt=r.childShapes.length;v!==tt;v++){var y=[],b=g.pop()||new n.Quaternion,p=d.pop()||new n.Vec3;for(o.mult(r.childOrientations[v],b),b.normalize(),o.vmult(r.childOffsets[v],p),f.vadd(p,p),s(y,i,r.childShapes[v],u,p,e,b,h,a),g.push(b),k=p,i||(nt+=y.length),w=0;w!==y.length;w++)o.vmult(r.childOffsets[v],k),y[w].rj.vadd(k,y[w].rj),t.push(y[w]);d.push(p)}}function a(n,t,r,u,f,e,o,s,h){var c=ei,l=oi,p,y,w,a,v;for(l.set(0,0,1),e.vmult(l,l),p=si,y=0;y!==r.vertices.length;y++)r.vertices[y].copy(c),o.vmult(c,c),f.vadd(c,c),c.vsub(u,p),w=l.dot(p),w<=0&&(a=hi,l.mult(l.dot(c),a),c.vsub(a,a),v=i(s,h),l.copy(v.ni),a.copy(v.ri),c.vsub(f,v.rj),n.push(v))}function ci(n,t,r,u,f,e,o,s,h){var w=v,l,p,a,c;if(t.findSeparatingAxis(r,u,e,f,o,w))for(l=[],p=y,t.clipAgainstHull(u,e,r,f,o,w,-100,100,l),a=0;a!==l.length;a++)c=i(s,h),w.negate(c.ni),l[a].normal.negate(p),p.mult(l[a].depth,p),l[a].point.vadd(p,c.ri),l[a].point.copy(c.rj),c.rj.vsub(f,c.rj),c.ri.vsub(u,c.ri),n.push(c)}function yi(n,t,r,u,f,e,o,s,h){var c=li,v,y,l,a;c.set(0,0,1);h.quaternion.vmult(c,c);v=ai;u.vsub(h.position,v);y=c.dot(v);y<=0&&(l=i(s,h),c.copy(l.ni),l.ni.negate(l.ni),l.ri.set(0,0,0),a=vi,c.mult(c.dot(u),a),u.vsub(a,a),a.copy(l.rj),n.push(l))}function pi(n,t,r,u,f,e,o,s,h){var l=p,a,c;l.set(0,0,1);u.vsub(f,l);a=l.norm2();a<=r.radius*r.radius&&(c=i(s,h),l.normalize(),l.copy(c.rj),c.rj.mult(r.radius,c.rj),l.copy(c.ni),c.ni.negate(c.ni),c.ri.set(0,0,0),n.push(c))}function k(n,t,r,u,f,e,o,s,h){var g=-1,p=bi,c=ki,y=null,it=0,l=wi,a,nt,tt,k,d,v;if(u.copy(l),l.vsub(f,l),o.conjugate(w),w.vmult(l,l),r.pointIsInside(l)){for(r.worldVerticesNeedsUpdate&&r.computeWorldVertices(f,o),r.worldFaceNormalsNeedsUpdate&&r.computeWorldFaceNormals(o),a=0,nt=r.faces.length;a!==nt;a++)tt=[r.worldVertices[r.faces[a][0]]],k=r.worldFaceNormals[a],u.vsub(tt[0],b),d=-k.dot(b),(y===null||Math.abs(d)<Math.abs(y))&&(y=d,g=a,k.copy(p),it++);g!==-1?(v=i(s,h),p.mult(y,c),c.vadd(u,c),c.vsub(f,c),c.copy(v.rj),p.negate(v.ni),v.ri.set(0,0,0),n.push(v)):console.warn("Point found inside convex, but did not find penetrating face!")}}function s(t,i,u,f,e,o,c,l,v){var tt=!1,y=n.Shape.types,it=y.SPHERE,ut=y.PLANE,ft=y.BOX,et=y.COMPOUND,ot=y.CONVEXPOLYHEDRON,p,w,b,nt,rt;if(i&&u?i.type>u.type&&(p=u,u=i,i=p,p=e,e=f,f=p,p=c,c=o,o=p,p=v,v=l,l=p,tt=!0):i&&!u&&(p=u,u=i,i=p,p=e,e=f,f=p,p=c,c=o,o=p,p=v,v=l,l=p,tt=!0),i&&u){if(i.type===it)switch(u.type){case it:d(t,i,u,f,e,o,c,l,v);break;case ut:g(t,i,u,f,e,o,c,l,v);break;case ft:at(t,i,u,f,e,o,c,l,v);break;case et:r(t,i,u,f,e,o,c,l,v);break;case ot:ii(t,i,u,f,e,o,c,l,v);break;default:console.warn("Collision between CANNON.Shape.types.SPHERE and "+u.type+" not implemented yet.")}else if(i.type===y.PLANE)switch(u.type){case y.PLANE:throw new Error("Plane-plane collision... wait, you did WHAT?");case y.BOX:fi(t,i,u,f,e,o,c,l,v);break;case y.COMPOUND:r(t,i,u,f,e,o,c,l,v);break;case y.CONVEXPOLYHEDRON:a(t,i,u,f,e,o,c,l,v);break;default:console.warn("Collision between CANNON.Shape.types.PLANE and "+u.type+" not implemented yet.")}else if(i.type===y.BOX)switch(u.type){case y.BOX:s(t,i.convexPolyhedronRepresentation,u.convexPolyhedronRepresentation,f,e,o,c,l,v);break;case y.COMPOUND:r(t,i,u,f,e,o,c,l,v);break;case y.CONVEXPOLYHEDRON:s(t,i.convexPolyhedronRepresentation,u,f,e,o,c,l,v);break;default:console.warn("Collision between CANNON.Shape.types.BOX and "+u.type+" not implemented yet.")}else if(i.type===y.COMPOUND)switch(u.type){case y.COMPOUND:r(t,i,u,f,e,o,c,l,v);break;case y.CONVEXPOLYHEDRON:for(w=[],r(w,u,i,e,f,c,o,v,l),b=0;b!==w.length;b++)h(w[b]),t.push(w[b]);break;default:console.warn("Collision between CANNON.Shape.types.COMPOUND and "+u.type+" not implemented yet.")}else if(i.type===y.CONVEXPOLYHEDRON)switch(u.type){case y.CONVEXPOLYHEDRON:ci(t,i,u,f,e,o,c,l,v);break;default:console.warn("Collision between CANNON.Shape.types.CONVEXPOLYHEDRON and "+u.type+" not implemented yet.")}}else switch(u.type){case y.PLANE:yi(t,i,u,f,e,o,c,l,v);break;case y.SPHERE:pi(t,i,u,f,e,o,c,l,v);break;case y.BOX:k(t,i,u.convexPolyhedronRepresentation,f,e,o,c,l,v);break;case y.CONVEXPOLYHEDRON:k(t,i,u,f,e,o,c,l,v);break;case y.COMPOUND:r(t,i,u,f,e,o,c,l,v);break;default:console.warn("Collision between CANNON.Particle and "+u.type+" not implemented yet.")}for(nt=0,rt=t.length;tt&&nt!==rt;nt++)h(t[nt])}var u,t,f,e,ri,ui,c,l,v,y,p;this.contactReduction=!1;u=[];t=new n.Vec3Pool;f=new n.Vec3;e=new n.Vec3;var nt=new n.Vec3,tt=new n.Vec3,it=new n.Vec3;var o=new n.Vec3,ut=new n.Vec3,ft=new n.Vec3,et=new n.Vec3,ot=[new n.Vec3,new n.Vec3,new n.Vec3,new n.Vec3,new n.Vec3,new n.Vec3],st=new n.Vec3,ht=new n.Vec3,ct=new n.Vec3,lt=new n.Vec3;var vt=new n.Vec3,yt=new n.Vec3,pt=new n.Vec3,wt=new n.Vec3,bt=new n.Vec3,kt=new n.Vec3,dt=new n.Vec3,gt=new n.Vec3,ni=new n.Vec3,ti=new n.Vec3;ri=new n.Vec3;ui=new n.Vec3;c=[];l=[];var ei=new n.Vec3,oi=new n.Vec3,si=new n.Vec3,hi=new n.Vec3;v=new n.Vec3;y=new n.Vec3;var li=new n.Vec3,ai=new n.Vec3,vi=new n.Vec3;p=new n.Vec3;var w=new n.Quaternion,wi=new n.Vec3,di=new n.Vec3,bi=new n.Vec3,b=new n.Vec3,ki=new n.Vec3;this.reduceContacts=function(){};this.getContacts=function(n,t,i,r,f){var e,c,o,h;for(u=f,e=0,c=n.length;e!==c;e++)o=n[e],h=t[e],s(r,o.shape,h.shape,o.position,h.position,o.quaternion,h.quaternion,o,h)}};n.Equation=function(n,t,i,r){this.id=-1;this.minForce=typeof i=="undefined"?-1e6:i;this.maxForce=typeof r=="undefined"?1e6:r;this.bi=n;this.bj=t;this.stiffness=1e7;this.regularizationTime=5;this.a=0;this.b=0;this.eps=0;this.spookParamsNeedsUpdate=!0};n.Equation.prototype.constructor=n.Equation;n.Equation.prototype.updateSpookParams=function(n){var t=this.regularizationTime,i=this.stiffness;this.a=4/(n*(1+4*t));this.b=4*t/(1+4*t);this.eps=4/(n*n*i*(1+4*t))};n.ContactEquation=function(t,i){n.Equation.call(this,t,i,0,1e6);this.restitution=0;this.ri=new n.Vec3;this.rj=new n.Vec3;this.penetrationVec=new n.Vec3;this.ni=new n.Vec3;this.rixn=new n.Vec3;this.rjxn=new n.Vec3;this.invIi=new n.Mat3;this.invIj=new n.Mat3;this.biInvInertiaTimesRixn=new n.Vec3;this.bjInvInertiaTimesRjxn=new n.Vec3};n.ContactEquation.prototype=new n.Equation;n.ContactEquation.prototype.constructor=n.ContactEquation;n.ContactEquation.prototype.reset=function(){this.invInertiaTimesRxnNeedsUpdate=!0};var rr=new n.Vec3,ur=new n.Vec3,fr=new n.Vec3;n.ContactEquation.prototype.computeB=function(n){var p=this.a,w=this.b,i=this.bi,r=this.bj,c=this.ri,l=this.rj,e=this.rixn,o=this.rjxn,f=fr,b=i.velocity,k=i.angularVelocity?i.angularVelocity:f,d=i.force,g=i.tau?i.tau:f,nt=r.velocity,tt=r.angularVelocity?r.angularVelocity:f,it=r.force,rt=r.tau?r.tau:f,t=this.penetrationVec,ut=i.invMass,ft=r.invMass,s=this.invIi,h=this.invIj,u;i.invInertia?s.setTrace(i.invInertia):s.identity();r.invInertia?h.setTrace(r.invInertia):h.identity();u=this.ni;c.cross(u,e);l.cross(u,o);t=this.penetrationVec;t.set(0,0,0);t.vadd(r.position,t);t.vadd(l,t);t.vsub(i.position,t);t.vsub(c,t);var et=u.dot(t),a=rr,v=ur;s.vmult(g,a);h.vmult(rt,v);var y=this.restitution+1,ot=y*nt.dot(u)-y*b.dot(u)+tt.dot(o)-k.dot(e),st=it.dot(u)*ft-d.dot(u)*ut+o.dot(v)-e.dot(a);return-et*p-ot*w-n*st};er=new n.Vec3;or=new n.Vec3;n.ContactEquation.prototype.computeC=function(){var r=this.bi,u=this.bj,n=this.rixn,t=this.rjxn,f=r.invMass,e=u.invMass,i=f+e+this.eps,o=this.invIi,s=this.invIj;return o.vmult(n,this.biInvInertiaTimesRixn),s.vmult(t,this.bjInvInertiaTimesRjxn),i+=this.biInvInertiaTimesRixn.dot(n),i+this.bjInvInertiaTimesRjxn.dot(t)};o=new n.Vec3;n.ContactEquation.prototype.computeGWlambda=function(){var t=this.bi,i=this.bj,r=o,n=0;return i.vlambda.vsub(t.vlambda,r),n+=r.dot(this.ni),t.wlambda&&(n-=t.wlambda.dot(this.rixn)),i.wlambda&&(n+=i.wlambda.dot(this.rjxn)),n};it=new n.Vec3;rt=new n.Vec3;n.ContactEquation.prototype.addToWlambda=function(n){var t=this.bi,i=this.bj,s=this.rixn,h=this.rjxn,e=t.invMass,o=i.invMass,f=this.ni,r=it,u=rt;f.mult(e*n,u);t.vlambda.vsub(u,t.vlambda);f.mult(o*n,u);i.vlambda.vadd(u,i.vlambda);t.wlambda!==undefined&&(this.biInvInertiaTimesRixn.mult(n,r),t.wlambda.vsub(r,t.wlambda));i.wlambda!==undefined&&(this.bjInvInertiaTimesRjxn.mult(n,r),i.wlambda.vadd(r,i.wlambda))};n.FrictionEquation=function(t,i,r){n.Equation.call(this,t,i,-r,r);this.ri=new n.Vec3;this.rj=new n.Vec3;this.t=new n.Vec3;this.rixt=new n.Vec3;this.rjxt=new n.Vec3;this.wixri=new n.Vec3;this.wjxrj=new n.Vec3;this.invIi=new n.Mat3;this.invIj=new n.Mat3;this.relVel=new n.Vec3;this.relForce=new n.Vec3;this.biInvInertiaTimesRixt=new n.Vec3;this.bjInvInertiaTimesRjxt=new n.Vec3};n.FrictionEquation.prototype=new n.Equation;n.FrictionEquation.prototype.constructor=n.FrictionEquation;var sr=new n.Vec3,hr=new n.Vec3,cr=new n.Vec3;n.FrictionEquation.prototype.computeB=function(n){var p=this.a,w=this.b,t=this.bi,i=this.bj,f=this.ri,e=this.rj,o=this.rixt,s=this.rjxt,h=this.wixri,c=this.wjxrj,u=cr,b=t.velocity,k=t.angularVelocity?t.angularVelocity:u,d=t.force,g=t.tau?t.tau:u,nt=i.velocity,tt=i.angularVelocity?i.angularVelocity:u,it=i.force,rt=i.tau?i.tau:u,st=this.relVel,ht=this.relForce,ut=t.invMass,ft=i.invMass,l=this.invIi,a=this.invIj,r=this.t,v=sr,y=hr;t.invInertia&&l.setTrace(t.invInertia);i.invInertia&&a.setTrace(i.invInertia);f.cross(r,o);e.cross(r,s);k.cross(f,h);tt.cross(e,c);l.vmult(g,v);a.vmult(rt,y);var et=nt.dot(r)-b.dot(r)+c.dot(r)-h.dot(r),ot=it.dot(r)*ft-d.dot(r)*ut+s.dot(y)-o.dot(v);return-0*p-et*w-n*ot};n.FrictionEquation.prototype.computeC=function(){var r=this.bi,u=this.bj,n=this.rixt,t=this.rjxt,f=r.invMass,e=u.invMass,i=f+e+this.eps,o=this.invIi,s=this.invIj;return o.vmult(n,this.biInvInertiaTimesRixt),s.vmult(t,this.bjInvInertiaTimesRjxt),i+=this.biInvInertiaTimesRixt.dot(n),i+this.bjInvInertiaTimesRjxt.dot(t)};ut=new n.Vec3;n.FrictionEquation.prototype.computeGWlambda=function(){var t=this.bi,i=this.bj,n=0,r=ut;return i.vlambda.vsub(t.vlambda,r),n+=r.dot(this.t),t.wlambda&&(n-=t.wlambda.dot(this.rixt)),i.wlambda&&(n+=i.wlambda.dot(this.rjxt)),n};ft=new n.Vec3;n.FrictionEquation.prototype.addToWlambda=function(n){var i=this.bi,r=this.bj,h=this.rixt,c=this.rjxt,o=i.invMass,s=r.invMass,e=this.t,t=ft,u=i.wlambda,f=r.wlambda;e.mult(o*n,t);i.vlambda.vsub(t,i.vlambda);e.mult(s*n,t);r.vlambda.vadd(t,r.vlambda);u&&(this.biInvInertiaTimesRixt.mult(n,t),u.vsub(t,u));f&&(this.bjInvInertiaTimesRjxt.mult(n,t),f.vadd(t,f))};n.RotationalEquation=function(t,i){n.Equation.call(this,t,i,-1e6,1e6);this.ni=new n.Vec3;this.nj=new n.Vec3;this.nixnj=new n.Vec3;this.njxni=new n.Vec3;this.invIi=new n.Mat3;this.invIj=new n.Mat3;this.relVel=new n.Vec3;this.relForce=new n.Vec3};n.RotationalEquation.prototype=new n.Equation;n.RotationalEquation.prototype.constructor=n.RotationalEquation;n.RotationalEquation.prototype.computeB=function(t){var c=this.a,l=this.b,i=this.bi,r=this.bj,u=this.ni,f=this.nj,e=this.nixnj,o=this.njxni,w=i.velocity,a=i.angularVelocity?i.angularVelocity:new n.Vec3,b=i.force,k=i.tau?i.tau:new n.Vec3,d=r.velocity,v=r.angularVelocity?r.angularVelocity:new n.Vec3,g=r.force,nt=r.tau?r.tau:new n.Vec3,tt=i.invMass,it=r.invMass,s=this.invIi,h=this.invIj;i.invInertia?s.setTrace(i.invInertia):s.identity();r.invInertia?h.setTrace(r.invInertia):h.identity();u.cross(f,e);f.cross(u,o);var y=-u.dot(f),p=o.dot(a)+e.dot(v);return-y*c-p*l-t*0};n.RotationalEquation.prototype.computeC=function(){var n=this.bi,t=this.bj,u=this.nixnj,f=this.njxni,o=n.invMass,s=t.invMass,e=this.eps,i=this.invIi,r=this.invIj;return n.invInertia?i.setTrace(n.invInertia):i.identity(),t.invInertia?r.setTrace(t.invInertia):r.identity(),e+=i.vmult(f).dot(f),e+r.vmult(u).dot(u)};o=new n.Vec3;n.RotationalEquation.prototype.computeGWlambda=function(){var t=this.bi,i=this.bj,r=o,n=0;return t.wlambda&&(n+=t.wlambda.dot(this.njxni)),i.wlambda&&(n+=i.wlambda.dot(this.nixnj)),n};n.RotationalEquation.prototype.addToWlambda=function(n){var t=this.bi,i=this.bj,u=this.nixnj,f=this.njxni,e=t.invMass,o=i.invMass,r;t.wlambda&&(r=this.invIi,t.wlambda.vsub(r.vmult(u).mult(n),t.wlambda));i.wlambda&&(r=this.invIj,i.wlambda.vadd(r.vmult(u).mult(n),i.wlambda))};n.Constraint=function(n,t){this.equations=[];this.bodyA=n;this.bodyB=t};n.Constraint.prototype.update=function(){throw new Error("method update() not implmemented in this Constraint subclass!");};n.DistanceConstraint=function(t,i,r,u){n.Constraint.call(this,t,i);typeof u=="undefined"&&(u=1e6);var e=this.equations=[new n.ContactEquation(t,i),],f=e[0];f.minForce=-u;f.maxForce=u;this.update=function(){i.position.vsub(t.position,f.ni);f.ni.normalize();f.ni.mult(r*.5,f.ri);f.ni.mult(-r*.5,f.rj)}};n.DistanceConstraint.prototype=new n.Constraint;n.RotationalMotorEquation=function(t,i,r){r=r||1e6;n.Equation.call(this,t,i,-r,r);this.axisA=new n.Vec3;this.axisB=new n.Vec3;this.invIi=new n.Mat3;this.invIj=new n.Mat3;this.targetVelocity=0};n.RotationalMotorEquation.prototype=new n.Equation;n.RotationalMotorEquation.prototype.constructor=n.RotationalMotorEquation;n.RotationalMotorEquation.prototype.computeB=function(t){var e=this.a,o=this.b,i=this.bi,r=this.bj,s=this.axisA,h=this.axisB,v=i.velocity,c=i.angularVelocity?i.angularVelocity:new n.Vec3,y=i.force,p=i.tau?i.tau:new n.Vec3,w=r.velocity,l=r.angularVelocity?r.angularVelocity:new n.Vec3,b=r.force,k=r.tau?r.tau:new n.Vec3,d=i.invMass,g=r.invMass,u=this.invIi,f=this.invIj;i.invInertia?u.setTrace(i.invInertia):u.identity();r.invInertia?f.setTrace(r.invInertia):f.identity();var a=s.dot(c)+h.dot(l)+this.targetVelocity;return-0*e-a*o-t*0};n.RotationalMotorEquation.prototype.computeC=function(){var n=this.bi,t=this.bj,e=this.axisA,i=this.axisB,o=n.invMass,s=t.invMass,f=this.eps,r=this.invIi,u=this.invIj;return n.invInertia?r.setTrace(n.invInertia):r.identity(),t.invInertia?u.setTrace(t.invInertia):u.identity(),f+=r.vmult(e).dot(i),f+u.vmult(i).dot(i)};o=new n.Vec3;n.RotationalMotorEquation.prototype.computeGWlambda=function(){var t=this.bi,i=this.bj,f=o,r=this.axisA,u=this.axisB,n=0;return t.wlambda&&(n+=t.wlambda.dot(r)),i.wlambda&&(n+=i.wlambda.dot(u)),n};n.RotationalMotorEquation.prototype.addToWlambda=function(n){var t=this.bi,i=this.bj,u=this.axisA,f=this.axisB,e=t.invMass,o=i.invMass,r;t.wlambda&&(r=this.invIi,t.wlambda.vsub(r.vmult(u).mult(n),t.wlambda));i.wlambda&&(r=this.invIj,i.wlambda.vadd(r.vmult(f).mult(n),i.wlambda))};n.HingeConstraint=function(t,i,r,u,f,e,o){var y,h,l;n.Constraint.call(this,t,u);o=o||1e6;y=this;h=this.equations=[new n.RotationalEquation(t,u),new n.RotationalEquation(t,u),new n.ContactEquation(t,u),new n.ContactEquation(t,u),new n.ContactEquation(t,u),];this.getRotationalEquation1=function(){return h[0]};this.getRotationalEquation2=function(){return h[1]};this.getPointToPointEquation1=function(){return h[2]};this.getPointToPointEquation2=function(){return h[3]};this.getPointToPointEquation3=function(){return h[4]};var w=this.getRotationalEquation1(),b=this.getRotationalEquation2(),s=this.getPointToPointEquation1(),a=this.getPointToPointEquation2(),v=this.getPointToPointEquation3(),c;a.minForce=v.minForce=s.minForce=-o;a.maxForce=v.maxForce=s.maxForce=o;var g=i.unit(),nt=f.unit(),p=new n.Vec3,k=new n.Vec3,d=new n.Vec3;r.cross(g,p);r.cross(p,k);e.cross(nt,d);p.normalize();d.normalize();l=!1;this.motorTargetVelocity=0;this.motorMinForce=-o;this.motorMaxForce=o;this.enableMotor=function(){l||(c=new n.RotationalMotorEquation(t,u,o),h.push(c),l=!0)};this.disableMotor=function(){l&&(l=!1,c=null,h.pop())};this.update=function(){s.ni.set(1,0,0);a.ni.set(0,1,0);v.ni.set(0,0,1);t.quaternion.vmult(i,s.ri);u.quaternion.vmult(f,s.rj);s.ri.copy(a.ri);s.rj.copy(a.rj);s.ri.copy(v.ri);s.rj.copy(v.rj);t.quaternion.vmult(p,w.ni);u.quaternion.vmult(e,w.nj);t.quaternion.vmult(k,b.ni);u.quaternion.vmult(e,b.nj);l&&(t.quaternion.vmult(r,c.axisA),u.quaternion.vmult(e,c.axisB),c.targetVelocity=y.motorTargetVelocity,c.maxForce=y.motorMaxForce,c.minForce=y.motorMinForce)}};n.HingeConstraint.prototype=new n.Constraint;n.PointToPointConstraint=function(t,i,r,u,f){n.Constraint.call(this,t,r);var h=this.equations=[new n.ContactEquation(t,r),new n.ContactEquation(t,r),new n.ContactEquation(t,r),],e=h[0],o=h[1],s=h[2];o.minForce=s.minForce=e.minForce=-f;o.maxForce=s.maxForce=e.maxForce=f;this.update=function(){r.position.vsub(t.position,e.ni);e.ni.normalize();t.quaternion.vmult(i,e.ri);r.quaternion.vmult(u,e.rj);e.ni.tangents(o.ni,s.ni);e.ri.copy(o.ri);e.rj.copy(o.rj);e.ri.copy(s.ri);e.rj.copy(s.rj)}};n.PointToPointConstraint.prototype=new n.Constraint;typeof module!="undefined"?module.exports=n:this.CANNON=n}).apply(this);
/*
//# sourceMappingURL=cannon.min.js.map
*/